/*
 Copyright (c) 2013, Pixel & Tonic, Inc.
 @license   http://buildwithcraft.com/license Craft License Agreement
 @link      http://buildwithcraft.com
*/
(function(d){"undefined"==typeof Craft&&(Craft={});d.extend(Craft,{navHeight:48,asciiCharMap:{223:"ss",224:"a",225:"a",226:"a",229:"a",227:"ae",230:"ae",228:"ae",231:"c",232:"e",233:"e",234:"e",235:"e",236:"i",237:"i",238:"i",239:"i",241:"n",242:"o",243:"o",244:"o",245:"o",246:"oe",249:"u",250:"u",251:"u",252:"ue",255:"y",257:"aa",269:"ch",275:"ee",291:"gj",299:"ii",311:"kj",316:"lj",326:"nj",353:"sh",363:"uu",382:"zh",256:"aa",268:"ch",274:"ee",290:"gj",298:"ii",310:"kj",315:"lj",325:"nj",352:"sh",
362:"uu",381:"zh"},t:function(a,b){"undefined"!=typeof Craft.translations[a]&&(a=Craft.translations[a]);if(b)for(var c in b)a=a.replace("{"+c+"}",b[c]);return a},escapeHtml:function(a){return d("<div/>").text(a).html()},getText:function(a){return d("<div/>").html(a).text()},encodeUriComponent:function(a){a=encodeURIComponent(a);var b={"!":"%21","*":"%2A","'":"%27","(":"%28",")":"%29"},c;for(c in b)a=a.replace(RegExp("\\"+c,"g"),b[c]);return a},formatInputId:function(a){return this.rtrim(a.replace(/[\[\]]+/g,
"-"),"-")},hasPackage:function(a){return-1!=d.inArray(a,Craft.packages)},getUrl:function(a,b,c){"string"!=typeof a&&(a="");if(-1!=a.search("://")||"//"==a.substr(0,2))return a;a=Craft.trim(a,"/");var e="";if(d.isPlainObject(b)){var f=[],g;for(g in b){var h=b[g];"#"==g?e=h:null!==h&&""!==h&&f.push(g+"="+h)}b=f}b=Garnish.isArray(b)?b.join("&"):Craft.trim(b,"&?");f=a.indexOf("?");-1!=f&&(b=a.substr(f+1)+(b?"&"+b:""),a=a.substr(0,f));c?a&&(f=c.match(/[&\?]p=[^&]+/))&&(c=c.replace(f[0],f[0]+"/"+a),a=""):
c=Craft.baseUrl;f=c.indexOf("?");"-1"!=f&&(b=c.substr(f+1)+(b?"&"+b:""),c=c.substr(0,f));!Craft.omitScriptNameInUrls&&a&&(Craft.usePathInfo?-1==c.search(Craft.scriptName)&&(c=Craft.rtrim(c,"/")+"/"+Craft.scriptName):(b&&"p="==b.substr(0,2)&&(f=b.indexOf("&"),-1!=f?(g=b.substring(2,f),b=b.substr(f+1)):(g=b.substr(2),b=null),g=Craft.rtrim(g),a=g+(a?"/"+a:"")),b="p="+a+(b?"&"+b:""),a=null));a&&(c=Craft.rtrim(c,"/")+"/"+a);b&&(c+="?"+b);e&&(c+="#"+e);return c},getCpUrl:function(a,b){return this.getUrl(a,
b,Craft.baseCpUrl)},getSiteUrl:function(a,b){return this.getUrl(a,b,Craft.baseSiteUrl)},getResourceUrl:function(a,b){return Craft.getUrl(a,b,Craft.resourceUrl)},getActionUrl:function(a,b){return Craft.getUrl(a,b,Craft.actionUrl)},redirectTo:function(a){document.location.href=this.getUrl(a)},postActionRequest:function(a,b,c,e){"function"==typeof b&&(e=c,c=b,b=void 0);return d.ajax(d.extend({url:Craft.getActionUrl(a),type:"POST",data:b,success:c,error:function(a,b,e){c(null,b,a)},complete:function(a,
b){"success"!=b&&("undefined"!=typeof Craft.cp?Craft.cp.displayError():alert(Craft.t("An unknown error occurred.")))}},e))},stringToArray:function(a){if("string"!=typeof a)return a;a=a.split(",");for(var b=0;b<a.length;b++)a[b]=d.trim(a[b]);return a},expandPostArray:function(a){var b={},c;for(c in a){var e=a[c],d=c.match(/^(\w+)(\[.*)?/);if(d[2])for(var g=d[2].match(/\[[^\[\]]*\]/g),h=0;h<g.length;h++)g[h]=g[h].substring(1,g[h].length-1);else g=[];g.unshift(d[1]);d=b;for(h=0;h<g.length;h++)h<g.length-
1?("object"!=typeof d[g[h]]&&(g[h+1]&&parseInt(g[h+1])!=g[h+1]?d[g[h]]={}:d[g[h]]=[]),d=d[g[h]]):(g[h]||(g[h]=d.length),d[g[h]]=e)}return b},compare:function(a,b){if(typeof a!=typeof b)return!1;if("object"==typeof a){if(a.length!=b.length||a instanceof Array!=b instanceof Array||!(a instanceof Array||Craft.compare(Craft.getObjectKeys(a),Craft.getObjectKeys(b))))return!1;for(var c in a)if(!Craft.compare(a[c],b[c]))return!1;return!0}return a===b},getObjectKeys:function(a){var b=[],c;for(c in a)b.push(c);
return b},escapeChars:function(a){Garnish.isArray(a)||(a=a.split());for(var b="",c=0;c<a.length;c++)b+="\\"+a[c];return b},ltrim:function(a,b){if(!a)return a;void 0===b&&(b=" \t\n\r\x00\x0B");var c=RegExp("^["+Craft.escapeChars(b)+"]+");return a.replace(c,"")},rtrim:function(a,b){if(!a)return a;void 0===b&&(b=" \t\n\r\x00\x0B");var c=RegExp("["+Craft.escapeChars(b)+"]+$");return a.replace(c,"")},trim:function(a,b){a=Craft.ltrim(a,b);return a=Craft.rtrim(a,b)},filterArray:function(a,b){for(var c=[],
d=0;d<a.length;d++)("function"==typeof b?b(a[d],d):a[d])&&c.push(a[d]);return c},inArray:function(a,b){return-1!=d.inArray(a,b)},removeFromArray:function(a,b){var c=d.inArray(a,b);return-1!=c?(b.splice(c,1),!0):!1},getLast:function(a){return a.length?a[a.length-1]:null},uppercaseFirst:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},lowercaseFirst:function(a){return a.charAt(0).toLowerCase()+a.slice(1)},asciiString:function(a){for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);32<=d&&
128>d?b+=a.charAt(c):"undefined"!=typeof Craft.asciiCharMap[d]&&(b+=Craft.asciiCharMap[d])}return b},preventOutlineOnMouseFocus:function(a){var b=d(a);b.on("mousedown.preventOutlineOnMouseFocus",function(){b.addClass("no-outline");b.focus()}).on("keydown.preventOutlineOnMouseFocus blur.preventOutlineOnMouseFocus",function(a){a.keyCode!=Garnish.SHIFT_KEY&&a.keyCode!=Garnish.CTRL_KEY&&a.keyCode!=Garnish.CMD_KEY&&b.removeClass("no-outline")})},createErrorList:function(a){for(var b=d(document.createElement("ul")).addClass("errors"),
c=0;c<a.length;c++){var e=d(document.createElement("li"));e.appendTo(b);e.html(a[c])}return b},initUiElements:function(a){d(".checkbox-select",a).checkboxselect();d(".fieldtoggle",a).fieldtoggle();d(".lightswitch",a).lightswitch();d(".nicetext",a).nicetext();d(".pill",a).pill();d(".menubtn",a).menubtn()},_elementIndexClasses:{},_elementSelectorModalClasses:{},registerElementIndexClass:function(a,b){if("undefined"!=typeof this._elementIndexClasses[a])throw"An element index class has already been registered for the element type \u201c"+
a+"\u201d.";this._elementIndexClasses[a]=b},registerElementSelectorModalClass:function(a,b){if("undefined"!=typeof this._elementSelectorModalClasses[a])throw"An element selector modal class has already been registered for the element type \u201c"+a+"\u201d.";this._elementSelectorModalClasses[a]=b},createElementIndex:function(a,b,c){return new ("undefined"!=typeof this._elementIndexClasses[a]?this._elementIndexClasses[a]:Craft.BaseElementIndex)(a,b,c)},createElementSelectorModal:function(a,b){return new ("undefined"!=
typeof this._elementSelectorModalClasses[a]?this._elementSelectorModalClasses[a]:Craft.BaseElementSelectorModal)(a,b)}});d.extend(d.fn,{disable:function(){return this.each(function(){var a=d(this);a.addClass("disabled");a.data("activatable")&&a.removeAttr("tabindex")})},enable:function(){return this.each(function(){var a=d(this);a.removeClass("disabled");a.data("activatable")&&a.attr("tabindex","0")})},checkboxselect:function(){return this.each(function(){d.data(this,"checkboxselect")||new Garnish.CheckboxSelect(this)})},
fieldtoggle:function(){return this.each(function(){d.data(this,"fieldtoggle")||new Craft.FieldToggle(this)})},lightswitch:function(a,b,c){return"settings"==a?("string"==typeof b?(a={},a[b]=c):a=b,this.each(function(){var b=d.data(this,"lightswitch");b&&b.setSettings(a)})):this.each(function(){d.data(this,"lightswitch")||new Craft.LightSwitch(this,a)})},nicetext:function(){return this.each(function(){d.data(this,"text")||new Garnish.NiceText(this)})},pill:function(){return this.each(function(){d.data(this,
"pill")||new Garnish.Pill(this)})},menubtn:function(){return this.each(function(){var a=d(this);!a.data("menubtn")&&a.next().hasClass("menu")&&new Garnish.MenuBtn(a)})}});Garnish.$doc.ready(function(){Craft.initUiElements()});Craft.BaseElementIndex=Garnish.Base.extend({elementType:null,instanceState:null,instanceStateStorageId:null,sourceStates:null,sourceStatesStorageId:null,searchTimeout:null,elementSelect:null,sourceSelect:null,$container:null,$main:null,$scroller:null,$toolbar:null,$search:null,
$viewModeBtnTd:null,$viewModeBtnContainer:null,viewModeBtns:null,viewMode:null,$mainSpinner:null,$loadingMoreSpinner:null,$sidebar:null,$sources:null,sourceKey:null,$source:null,$sourceToggles:null,$elements:null,$table:null,$elementContainer:null,init:function(a,b,c){this.elementType=a;this.$container=b;this.setSettings(c,Craft.BaseElementIndex.defaults);this.instanceState={selectedSource:null};this.sourceStates={};"undefined"!==typeof Storage&&(this.settings.storageKey&&(this.instanceStateStorageId=
"Craft-"+Craft.siteUid+"."+this.settings.storageKey,"undefined"!=typeof localStorage[this.instanceStateStorageId]&&d.extend(this.instanceState,JSON.parse(localStorage[this.instanceStateStorageId]))),this.sourceStatesStorageId="Craft-"+Craft.siteUid+".BaseElementIndex."+this.elementType+"."+this.settings.context,"undefined"!=typeof localStorage[this.sourceStatesStorageId]&&d.extend(this.sourceStates,JSON.parse(localStorage[this.sourceStatesStorageId])));this.$main=this.$container.find(".main");this.$toolbar=
this.$container.find(".toolbar:first");this.$search=this.$toolbar.find(".search:first input:first");this.$mainSpinner=this.$toolbar.find(".spinner:first");this.$loadingMoreSpinner=this.$container.find(".spinner.loadingmore");this.$sidebar=this.$container.find(".sidebar:first");this.$sources=this.$sidebar.find("nav a");this.$sourceToggles=this.$sidebar.find(".toggle");this.$elements=this.$container.find(".elements:first");this.viewModeBtns={};this.$viewModeBtnTd=this.$toolbar.find(".viewbtns:first");
this.$viewModeBtnContainer=d('<div class="btngroup"/>').appendTo(this.$viewModeBtnTd);a=[{mode:"table",title:Craft.t("Display in a table"),icon:"list"},{mode:"structure",title:Craft.t("Display hierarchically"),icon:"structure"},{mode:"thumbs",title:Craft.t("Display as thumbnails"),icon:"grid"}];for(b=0;b<a.length;b++){c=a[b];var e=d('<div class="btn" title="'+c.title+'" data-icon="'+c.icon+'" data-view="'+c.mode+'" role="button"/>');this.viewModeBtns[c.mode]=e;this.addListener(e,"click",{mode:c.mode},
function(a){this.selectViewMode(a.data.mode);this.updateElements()})}this.viewModeBtns.table.appendTo(this.$viewModeBtnContainer);if(0!=this.$sources.length){this.onAfterHtmlInit();this.$scroller="index"==this.settings.context?Garnish.$win:this.$main;if(a=this.getDefaultSourceKey()){var f=this.getSourceByKey(a);f&&f.parentsUntil(".sidebar","li").not(":first").addClass("expanded")}a&&f||(f=this.$sources.first());this.selectSource(f);this.updateElements();this.addListener(this.$sourceToggles,"click",
function(a){d(a.currentTarget).parent().toggleClass("expanded");a.stopPropagation()});this.sourceSelect=new Garnish.Select(this.$sidebar.find("nav"),this.$sources,{selectedClass:"sel",multi:!1,vertical:!0,onSelectionChange:d.proxy(this,"onSourceSelectionChange")});this.addListener(this.$search,"textchange",d.proxy(function(){this.searchTimeout&&clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(d.proxy(this,"updateElements"),500)},this));Garnish.isMobileBrowser(!0)||this.$search.focus()}},
getDefaultSourceKey:function(){return this.instanceState.selectedSource},onSourceSelectionChange:function(){var a=this.$sources.filter(".sel");0==a.length&&(a=this.$sources.filter(":first"));this.selectSource(a);this.updateElements()},setInstanceState:function(a,b){"object"==typeof a?d.extend(this.instanceState,a):this.instanceState[a]=b;this.instanceStateStorageId&&(localStorage[this.instanceStateStorageId]=JSON.stringify(this.instanceState))},getSourceState:function(a,b,c){"undefined"==typeof this.sourceStates[a]&&
(this.sourceStates[a]={});return"undefined"==typeof b?this.sourceStates[a]:"undefined"!=typeof this.sourceStates[a][b]?this.sourceStates[a][b]:"undefined"!=typeof c?c:null},getSelectedSourceState:function(a,b){return this.getSourceState(this.instanceState.selectedSource,a,b)},setSelecetedSourceState:function(a,b){var c=this.getSelectedSourceState();"object"==typeof a?d.extend(c,a):c[a]=b;this.sourceStates[this.instanceState.selectedSource]=c;this.sourceStatesStorageId&&(localStorage[this.sourceStatesStorageId]=
JSON.stringify(this.sourceStates))},getControllerData:function(){return{context:this.settings.context,elementType:this.elementType,criteria:this.settings.criteria,disabledElementIds:this.settings.disabledElementIds,source:this.instanceState.selectedSource,viewState:this.getSelectedSourceState(),search:this.$search?this.$search.val():null}},updateElements:function(){this.$mainSpinner.removeClass("hidden");this.removeListener(this.$scroller,"scroll");"table"==this.getSelectedSourceState("mode")&&this.$table&&
(Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.not(this.$table));"structure"==this.getSelectedSourceState("mode")&&this.$search&&this.$search.val()&&this.selectViewMode("table");var a=this.getControllerData();Craft.postActionRequest("elements/getElements",a,d.proxy(function(a,c){this.$mainSpinner.addClass("hidden");"success"==c&&this.setNewElementDataHtml(a,!1)},this))},setNewElementDataHtml:function(a,b){if(b)this.$elementContainer.append(a.html);else if(this.$elements.html(a.html),"table"==
this.getSelectedSourceState("mode")){var c=this.$elements.find("thead:first th");this.addListener(c,"click","onSortChange");this.$table=this.$elements.find("table:first");this.$elementContainer=this.$table.find("tbody:first");Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.add(this.$table)}else this.$elementContainer=this.$elements.children("ul");d("head").append(a.headHtml);Craft.cp.setMaxSidebarHeight();a.more&&(this.totalVisible=a.totalVisible,this.addListener(this.$scroller,"scroll",function(){if(this.$scroller[0]==
Garnish.$win[0]&&Garnish.$win.innerHeight()+Garnish.$bod.scrollTop()>=Garnish.$bod.height()||this.$scroller.prop("scrollHeight")-this.$scroller.scrollTop()==this.$scroller.outerHeight()){this.$loadingMoreSpinner.removeClass("hidden");this.removeListener(this.$scroller,"scroll");var a=this.getControllerData();a.offset=this.totalVisible;Craft.postActionRequest("elements/getElements",a,d.proxy(function(a,b){this.$loadingMoreSpinner.addClass("hidden");"success"==b&&this.setNewElementDataHtml(a,!0)},this))}}));
switch(this.getSelectedSourceState("mode")){case "table":Craft.cp.updateResponsiveTables();break;case "structure":for(var c=this.$elementContainer.find("ul").prev(".row"),e=this.getSelectedSourceState("collapsedElementIds",[]),f=0;f<c.length;f++){var g=d(c[f]),h=g.parent(),k=d('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(g);-1!=d.inArray(g.data("id"),e)&&h.addClass("collapsed");this.initToggle(k)}"index"==this.settings.context&&this.$source.data("sortable")&&(this.$elementContainer.find(".add").click(d.proxy(function(a){a=
d(a.currentTarget);if(!a.data("menubtn")){var b=a.parent().data("id"),b=Craft.getUrl(this.$source.data("new-child-url"),"parentId="+b);d('<div class="menu"><ul><li><a href="'+b+'">'+Craft.t("New child")+"</a></li></ul></div>").insertAfter(a);(new Garnish.MenuBtn(a)).showMenu()}},this)),this.structureDrag=new Craft.StructureDrag(this,this.$source.data("move-action"),this.$source.data("max-depth")))}this.onUpdateElements(b)},initToggle:function(a){a.click(d.proxy(function(a){a=d(a.currentTarget).closest("li");
var c=a.children(".row").data("id"),e=this.getSelectedSourceState("collapsedElementIds",[]),f=d.inArray(c,e);a.hasClass("collapsed")?(a.removeClass("collapsed"),-1!=f&&e.splice(f,1)):(a.addClass("collapsed"),-1==f&&e.push(c));this.setSelecetedSourceState("collapsedElementIds",e)},this))},onUpdateElements:function(a){this.settings.onUpdateElements(a)},onSortChange:function(a){a=d(a.currentTarget).attr("data-attribute");this.getSelectedSourceState("order")==a?"asc"==this.getSelectedSourceState("sort")?
this.setSelecetedSourceState("sort","desc"):this.setSelecetedSourceState("sort","asc"):this.setSelecetedSourceState({order:a,sort:"asc"});this.updateElements()},getSourceByKey:function(a){for(var b=0;b<this.$sources.length;b++){var c=d(this.$sources[b]);if(c.data("key")==a)return c}},selectSource:function(a){this.$source!=a&&(this.$source&&this.$source.removeClass("sel"),this.sourceKey=a.data("key"),this.$source=a.addClass("sel"),this.setInstanceState("selectedSource",this.sourceKey),this.$search&&
(this.$search.data("textchangeValue",""),this.$search.val("")),this.setViewModeForNewSource(),this.onSelectSource())},setViewModeForNewSource:function(){var a=this.getSelectedSourceState("mode");a&&this.doesSourceHaveViewMode(a)||(a=this.doesSourceHaveViewMode("structure")?"structure":this.viewMode&&this.doesSourceHaveViewMode(this.viewMode)?this.viewMode:"table");this.selectViewMode(a);var b=!1;for(a in this.viewModeBtns)"table"!=a&&(this.doesSourceHaveViewMode(a)?(this.viewModeBtns[a].appendTo(this.$viewModeBtnContainer),
b=!0):this.viewModeBtns[a].detach());b?this.$viewModeBtnTd.removeClass("hidden"):this.$viewModeBtnTd.addClass("hidden")},onSelectSource:function(){this.settings.onSelectSource(this.sourceKey)},onAfterHtmlInit:function(){this.settings.onAfterHtmlInit()},doesSourceHaveViewMode:function(a){return"table"==a||this.$source.data("has-"+a)},selectViewMode:function(a){this.doesSourceHaveViewMode(a)||(a="table");this.viewMode&&this.viewModeBtns[this.viewMode].removeClass("active");this.viewMode=a;this.viewModeBtns[this.viewMode].addClass("active");
this.setSelecetedSourceState("mode",this.viewMode)},rememberDisabledElementId:function(a){-1==d.inArray(a,this.settings.disabledElementIds)&&this.settings.disabledElementIds.push(a)},forgetDisabledElementId:function(a){a=d.inArray(a,this.settings.disabledElementIds);-1!=a&&this.settings.disabledElementIds.splice(a,1)},enableElements:function(a){a.removeClass("disabled");for(var b=0;b<a.length;b++){var c=d(a[b]).data("id");this.forgetDisabledElementId(c)}this.settings.onEnableElements(a)},disableElements:function(a){a.removeClass("sel").addClass("disabled");
for(var b=0;b<a.length;b++){var c=d(a[b]).data("id");this.rememberDisabledElementId(c)}this.settings.onDisableElements(a)},getElementById:function(a){return this.$elementContainer.find("[data-id="+a+"]:first")},enableElementsById:function(a){a=d.makeArray(a);for(var b=0;b<a.length;b++){var c=a[b],e=this.getElementById(c);e.length?this.enableElements(e):this.forgetDisabledElementId(c)}},disableElementsById:function(a){a=d.makeArray(a);for(var b=0;b<a.length;b++){var c=a[b],e=this.getElementById(c);
e.length?this.disableElements(e):this.rememberDisabledElementId(c)}},setElementSelect:function(a){this.elementSelect=a},addCallback:function(a,b){return d.proxy(function(){"function"==typeof a&&a.apply(this,arguments);b.apply(this,arguments)},this)},setIndexBusy:function(){this.$mainSpinner.removeClass("hidden");this.isIndexBusy=!0},setIndexAvailable:function(){this.$mainSpinner.addClass("hidden");this.isIndexBusy=!1}},{defaults:{context:"index",storageKey:null,criteria:null,disabledElementIds:[],
onUpdateElements:d.noop,onEnableElements:d.noop,onDisableElements:d.noop,onSelectSource:d.noop,onAfterHtmlInit:d.noop}});Craft.BaseElementSelectInput=Garnish.Base.extend({id:null,name:null,elementType:null,sources:null,criteria:null,disabledElementIds:null,limit:null,storageKey:null,totalElements:0,elementSelect:null,elementSort:null,modal:null,$container:null,$elementsContainer:null,$elements:null,$addElementBtn:null,init:function(a,b,c,e,f,g,h,k){this.id=a;this.name=b;this.elementType=c;this.sources=
e;this.criteria=f;this.disabledElementIds=g;this.limit=h;this.storageKey=k;this.$container=d("#"+this.id);this.$elementsContainer=this.$container.children(".elements");this.$elements=this.$elementsContainer.children();this.$addElementBtn=this.$container.children(".btn.add");this.totalElements=this.$elements.length;this.limit&&this.totalElements>=this.limit&&this.$addElementBtn.addClass("disabled");this.elementSelect=new Garnish.Select(this.$elements,{multi:!0,filter:":not(.delete)"});this.elementSort=
new Garnish.DragSort({container:this.$elementsContainer,filter:d.proxy(function(){return this.elementSelect.getSelectedItems()},this),caboose:d('<div class="caboose"/>'),onSortChange:d.proxy(function(){this.elementSelect.resetItemOrder()},this)});this.initElements(this.$elements);this.addListener(this.$addElementBtn,"activate","showModal")},initElements:function(a){this.elementSelect.addItems(a);this.elementSort.addItems(a);a.find(".delete").on("click",d.proxy(function(a){var c=d(a.currentTarget).closest(".element");
this.$elements=this.$elements.not(c);this.elementSelect.removeItems(c);this.modal&&this.modal.elementIndex.enableElementsById(c.data("id"));this.totalElements--;this.$addElementBtn&&this.$addElementBtn.removeClass("disabled");c.css("z-index",0);c.animate({marginLeft:-(c.outerWidth()+parseInt(c.css("margin-right"))),opacity:-1},"fast",function(){c.remove()})},this))},showModal:function(){if(!this.limit||this.totalElements!=this.limit)if(this.modal)this.modal.show();else{for(var a=this.disabledElementIds?
this.disabledElementIds.slice(0):[],b=0;b<this.$elements.length;b++){var c=d(this.$elements[b]);a.push(c.data("id"))}this.modal=Craft.createElementSelectorModal(this.elementType,{storageKey:this.storageKey?"BaseElementSelectInput."+this.storageKey:null,sources:this.sources,criteria:this.criteria,multiSelect:!0,disableOnSelect:!0,disabledElementIds:a,onSelect:d.proxy(this,"selectElements")})}},selectElements:function(a){this.elementSelect.deselectAll();for(var b=this.limit?Math.min(a.length,this.limit-
this.totalElements):a.length,c=0;c<b;c++){var e=a[c],f=e.$element.clone();f.addClass("removable");f.prepend('<input type="hidden" name="'+this.name+'[]" value="'+e.id+'"><a class="delete icon" title="'+Craft.t("Remove")+'"></a>');f.appendTo(this.$elementsContainer);var e=e.$element.offset(),g=f.offset();f.css({left:e.left-g.left,top:e.top-g.top,zIndex:1E4});f.animate({left:0,top:0},function(){d(this).css("z-index",1)});this.$elements=this.$elements.add(f);this.initElements(f)}this.totalElements+=
b;this.limit&&this.totalElements==this.limit&&this.$addElementBtn.addClass("disabled")}});Craft.BaseElementSelectorModal=Garnish.Modal.extend({elementType:null,elementIndex:null,elementSelect:null,$body:null,$selectBtn:null,$sidebar:null,$sources:null,$sourceToggles:null,$main:null,$search:null,$elements:null,$tbody:null,$buttons:null,$cancelBtn:null,$selectBtn:null,init:function(a,b){this.elementType=a;this.setSettings(b,Craft.BaseElementSelectorModal.defaults);var c=d('<div class="modal elementselectormodal"></div>').appendTo(Garnish.$bod),
e=d('<div class="body"><div class="spinner big"></div></div>').appendTo(c),f=d('<div class="footer"/>').appendTo(c);this.base(c,b);this.$buttons=d('<div class="buttons rightalign"/>').appendTo(f);this.$cancelBtn=d('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(this.$buttons);this.$selectBtn=d('<div class="btn disabled submit">'+Craft.t("Select")+"</div>").appendTo(this.$buttons);this.$body=e;this.addListener(this.$cancelBtn,"activate","cancel");this.addListener(this.$selectBtn,"activate",
"selectElements")},onFadeIn:function(){this.elementIndex?Garnish.isMobileBrowser(!0)||this.elementIndex.$search.focus():Craft.postActionRequest("elements/getModalBody",{context:"modal",elementType:this.elementType,sources:this.settings.sources},d.proxy(function(a,b){"success"==b&&(this.$body.html(a),this.elementIndex=Craft.createElementIndex(this.elementType,this.$body,{context:"modal",storageKey:this.settings.storageKey,criteria:this.settings.criteria,disabledElementIds:this.settings.disabledElementIds,
onUpdateElements:d.proxy(this,"onUpdateElements"),onEnableElements:d.proxy(this,"onEnableElements"),onDisableElements:d.proxy(this,"onDisableElements")}))},this));this.base()},onUpdateElements:function(a){a||this.addListener(this.elementIndex.$elementContainer,"dblclick","selectElements");this.elementSelect&&(this.elementSelect.destroy(),delete this.elementSelect);a="structure"==this.elementIndex.getSelectedSourceState("mode")?this.elementIndex.$elementContainer.find(".row:not(.disabled)"):this.elementIndex.$elementContainer.children(":not(.disabled)");
this.elementSelect=new Garnish.Select(this.elementIndex.$elementContainer,a,{multi:this.settings.multiSelect,vertical:"thumbs"!=this.elementIndex.getSelectedSourceState("mode"),onSelectionChange:d.proxy(this,"onSelectionChange")});this.elementIndex.setElementSelect(this.elementSelect)},onSelectionChange:function(){this.elementSelect.totalSelected?this.$selectBtn.removeClass("disabled"):this.$selectBtn.addClass("disabled")},onEnableElements:function(a){this.elementSelect.addItems(a)},onDisableElements:function(a){this.elementSelect.removeItems(a)},
cancel:function(){this.hide();this.settings.onCancel()},selectElements:function(){if(this.elementIndex&&this.elementSelect&&this.elementSelect.totalSelected){this.elementSelect.clearMouseUpTimeout();this.hide();var a=this.elementSelect.getSelectedItems(),a=this.getElementInfo(a);this.onSelect(a);this.settings.disableOnSelect&&this.elementIndex.disableElements(this.elementSelect.getSelectedItems())}},getElementInfo:function(a){for(var b=[],c=0;c<a.length;c++){var e=d(a[c]),f=e.find(".element:first");
b.push({id:e.data("id"),label:e.data("label"),status:e.data("status"),url:f.data("url"),hasThumb:f.hasClass("hasthumb"),$element:f})}return b},onSelect:function(a){this.settings.onSelect(a)}},{defaults:{storageKey:null,sources:null,criteria:null,multiSelect:!1,disabledElementIds:[],disableOnSelect:!1,onCancel:d.noop,onSelect:d.noop}});Craft.BaseInputGenerator=Garnish.Base.extend({$source:null,$target:null,settings:null,listening:null,timeout:null,init:function(a,b,c){this.$source=d(a);this.$target=
d(b);this.setSettings(c);this.startListening()},setNewSource:function(a){var b=this.listening;this.stopListening();this.$source=d(a);b&&this.startListening()},startListening:function(){this.listening||(this.listening=!0,this.addListener(this.$source,"textchange","onTextChange"),this.addListener(this.$target,"focus",function(){this.addListener(this.$target,"textchange","stopListening");this.addListener(this.$target,"blur",function(){this.removeListener(this.$target,"textchange,blur")})}))},stopListening:function(){this.listening&&
(this.listening=!1,this.removeAllListeners(this.$source),this.removeAllListeners(this.$target))},onTextChange:function(){this.timeout&&clearTimeout(this.timeout);this.timeout=setTimeout(d.proxy(this,"updateTarget"),250)},updateTarget:function(){var a=this.$source.val(),a=this.generateTargetValue(a);this.$target.val(a);this.$target.trigger("textchange")},generateTargetValue:function(a){return a}});Craft.AdminTable=Garnish.Base.extend({settings:null,totalObjects:null,sorter:null,$noObjects:null,$table:null,
$tbody:null,$deleteBtns:null,init:function(a){this.setSettings(a,Craft.AdminTable.defaults);this.settings.allowDeleteAll||(this.settings.minObjects=1);this.$noObjects=d(this.settings.noObjectsSelector);this.$table=d(this.settings.tableSelector);this.$tbody=this.$table.children("tbody");this.totalObjects=this.$tbody.children().length;this.settings.sortable&&(this.sorter=new Craft.DataTableSorter(this.$table,{onSortChange:d.proxy(this,"reorderObjects")}));this.$deleteBtns=this.$table.find(".delete");
this.addListener(this.$deleteBtns,"click","deleteObject");this.updateUI()},addRow:function(a){if(!(this.settings.maxObjects&&this.totalObjects>=this.settings.maxObjects)){a=d(a).appendTo(this.$tbody);var b=a.find(".delete");this.settings.sortable&&this.sorter.addItems(a);this.$deleteBtns=this.$deleteBtns.add(b);this.addListener(b,"click","deleteObject");this.totalObjects++;this.updateUI()}},reorderObjects:function(){if(!this.settings.sortable)return!1;for(var a=[],b=0;b<this.sorter.$items.length;b++){var c=
d(this.sorter.$items[b]).attr(this.settings.idAttribute);a.push(c)}a={ids:JSON.stringify(a)};Craft.postActionRequest(this.settings.reorderAction,a,d.proxy(function(a,b){"success"==b&&(a.success?Craft.cp.displayNotice(Craft.t(this.settings.reorderSuccessMessage)):Craft.cp.displayError(Craft.t(this.settings.reorderFailMessage)))},this))},deleteObject:function(a){if(!(this.settings.minObjects&&this.totalObjects<=this.settings.minObjects)){var b=d(a.target).closest("tr"),c=b.attr(this.settings.idAttribute),
e=b.attr(this.settings.nameAttribute);this.confirmDeleteObject(b)&&Craft.postActionRequest(this.settings.deleteAction,{id:c},d.proxy(function(a,d){"success"==d&&(a.success?(b.remove(),this.totalObjects--,this.updateUI(),this.onDeleteObject(c),Craft.cp.displayNotice(Craft.t(this.settings.deleteSuccessMessage,{name:e}))):Craft.cp.displayError(Craft.t(this.settings.deleteFailMessage,{name:e})))},this))}},confirmDeleteObject:function(a){a=a.attr(this.settings.nameAttribute);return confirm(Craft.t(this.settings.confirmDeleteMessage,
{name:a}))},onDeleteObject:function(a){this.settings.onDeleteObject(a)},updateUI:function(){0==this.totalObjects?(this.$table.hide(),this.$noObjects.removeClass("hidden")):(this.$table.show(),this.$noObjects.addClass("hidden"));if(this.settings.sortable){var a=this.$table.find(".move");1==this.totalObjects?a.addClass("disabled"):a.removeClass("disabled")}this.settings.minObjects&&this.totalObjects<=this.settings.minObjects?this.$deleteBtns.addClass("disabled"):this.$deleteBtns.removeClass("disabled");
this.settings.newObjectBtnSelector&&(this.settings.maxObjects&&this.totalObjects>=this.settings.maxObjects?d(this.settings.newObjectBtnSelector).addClass("hidden"):d(this.settings.newObjectBtnSelector).removeClass("hidden"))}},{defaults:{tableSelector:null,noObjectsSelector:null,newObjectBtnSelector:null,idAttribute:"data-id",nameAttribute:"data-name",sortable:!1,allowDeleteAll:!0,minObjects:0,maxObjects:null,reorderAction:null,deleteAction:null,reorderSuccessMessage:Craft.t("New order saved."),reorderFailMessage:Craft.t("Couldn\u2019t save new order."),
confirmDeleteMessage:Craft.t("Are you sure you want to delete \u201c{name}\u201d?"),deleteSuccessMessage:Craft.t("\u201c{name}\u201d deleted."),deleteFailMessage:Craft.t("Couldn\u2019t delete \u201c{name}\u201d."),onDeleteObject:d.noop}});Craft.AssetIndex=Craft.BaseElementIndex.extend({$buttons:null,$uploadButton:null,$progressBar:null,$folders:null,$previouslySelectedFolder:null,uploader:null,promptHandler:null,progressBar:null,initialSourceKey:null,isIndexBusy:!1,_uploadTotalFiles:0,_uploadFileProgress:{},
_uploadedFileIds:[],_selectedFileIds:[],_singleFileMenu:null,_multiFileMenu:null,_fileDrag:null,_folderDrag:null,_expandDropTargetFolderTimeout:null,_tempExpandedFolders:[],init:function(a,b,c){this.base(a,b,c);"index"==this.settings.context&&this.initIndexMode()},initIndexMode:function(){var a=this;this._fileDrag=new Garnish.DragDrop({activeDropTargetClass:"sel assets-fm-dragtarget",helperOpacity:0.5,filter:d.proxy(function(){return this.elementSelect.getSelectedItems()},this),helper:d.proxy(function(a){return this._getDragHelper(a)},
this),dropTargets:d.proxy(function(){var a=[];this.$sources.each(function(){a.push(d(this))});return a},this),onDragStart:d.proxy(function(){this._tempExpandedFolders=[];this.$previouslySelectedFolder=this.$source.removeClass("sel")},this),onDropTargetChange:d.proxy(this,"_onDropTargetChange"),onDragStop:d.proxy(this,"_onFileDragStop")});this._folderDrag=new Garnish.DragDrop({activeDropTargetClass:"sel assets-fm-dragtarget",helperOpacity:0.5,filter:d.proxy(function(){for(var a=this.sourceSelect.getSelectedItems(),
c=[],e=0;e<a.length;e++){var f=d(a[e]).parent();1<f.parents("ul").length&&c.push(f[0])}return d(c)},this),helper:d.proxy(function(a){var c=d('<ul class="assets-fm-folderdrag" />').append(a);a.removeClass("expanded");c.width(this.$sidebar[0].scrollWidth);return c},this),dropTargets:d.proxy(function(){var b=[];this.$sources.each(function(){d(this).is(a._folderDrag.$draggee)||b.push(d(this))});return b},this),onDragStart:d.proxy(function(){this._tempExpandedFolders=[];this._folderDrag.$draggee.filter(".expanded").removeClass("expanded").addClass("expanded-tmp")},
this),onDropTargetChange:d.proxy(this,"_onDropTargetChange"),onDragStop:d.proxy(this,"_onFolderDragStop")});this.$sources.each(function(){a._createFolderContextMenu.apply(a,d(this));1<d(this).parents("ul").length&&a._folderDrag.addItems(d(this).parent())})},_onFileDragStop:function(){if(this._fileDrag.$activeDropTarget){this._fileDrag.$activeDropTarget.addClass("sel");for(var a=this._getFolderIdFromSourceKey(this._fileDrag.$activeDropTarget.data("key")),b=[],c=[],e=0;e<this._fileDrag.$draggee.length;e++){var f=
this._fileDrag.$draggee[e].getAttribute("data-id"),g=d(this._fileDrag.$draggee[e]).find("[data-url]").attr("data-url").split("/").pop();b.push(f);c.push(g)}if(b.length){this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(b.length);this.progressBar.showProgressBar();for(var h=[],e=0;e<b.length;e++)h.push({fileId:b[e],folderId:a,fileName:c[e]});var k=d.proxy(function(b){this.promptHandler.resetPrompts();for(var c=0;c<b.length;c++){var e=b[c];e.prompt&&this.promptHandler.addPrompt(e);
e.error&&alert(e.error)}this.setIndexAvailable();this.progressBar.hideProgressBar();this.promptHandler.getPromptCount()?(b=d.proxy(function(b){for(var c=[],d=0;d<b.length;d++)if("cancel"!=b[d].choice)for(var e=0;e<h.length;e++)h[e].fileName==b[d].fileName&&(h[e].action=b[d].choice,c.push(h[e]));0==c.length?this._selectSourceByFolderId(a):(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),this._moveFile(c,
0,k))},this),this._fileDrag.fadeOutHelpers(),this.promptHandler.showBatchPrompts(b)):(this._fileDrag.fadeOutHelpers(),this._selectSourceByFolderId(a))},this);this._moveFile(h,0,k);return}}else this._collapseExtraExpandedFolders();this.$previouslySelectedFolder.addClass("sel");this._fileDrag.returnHelpersToDraggees()},_onFolderDragStop:function(){this._folderDrag.$draggee.filter(".expanded-tmp").removeClass("expanded-tmp").addClass("expanded");if(this._folderDrag.$activeDropTarget&&0==this._folderDrag.$activeDropTarget.siblings("ul").find(">li").filter(this._folderDrag.$draggee).length){var a=
this._getFolderIdFromSourceKey(this._folderDrag.$activeDropTarget.data("key"));this._collapseExtraExpandedFolders(a);for(var b=[],c=0;c<this._folderDrag.$draggee.length;c++){var e=d("> a",this._folderDrag.$draggee[c]),e=this._getFolderIdFromSourceKey(e.data("key")),f=this._getSourceByFolderId(e);this._getFolderIdFromSourceKey(this._getParentSource(f).data("key"))!=a&&b.push(e)}if(b.length){b.sort();b.reverse();this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(b.length);
this.progressBar.showProgressBar();for(var g=[],h=[],c=0;c<b.length;c++)h.push({folderId:b[c],parentId:a});this.requestId++;var k=[],m=[],l={},p=[],n=d.proxy(function(b){this.promptHandler.resetPrompts();for(var c=0;c<b.length;c++){var e=b[c];if(e.success&&e.transferList&&e.deleteList&&e.changedFolderIds){for(var f=0;f<e.transferList.length;f++)k.push(e.transferList[f]);for(f=0;f<e.deleteList.length;f++)m.push(e.deleteList[f]);for(var g in e.changedFolderIds)l[g]=e.changedFolderIds[g];p.push(e.removeFromTree)}e.prompt&&
this.promptHandler.addPrompt(e);e.error&&alert(e.error)}this.promptHandler.getPromptCount()?(b=d.proxy(function(a){this.promptHandler.resetPrompts();this.setNewElementDataHtml("");for(var b=[],c=0;c<a.length;c++)"cancel"!=a[c].choice&&(h[0].action=a[c].choice,b.push(h[0]));0==b.length?d.proxy(this,"_performActualFolderMove",k,m,l,p)():(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),q(b,0,
n))},this),this.promptHandler.showBatchPrompts(b),this.setIndexAvailable(),this.progressBar.hideProgressBar()):d.proxy(this,"_performActualFolderMove",k,m,l,p,a)()},this),q=d.proxy(function(a,b,c){0==b&&(g=[]);Craft.postActionRequest("assets/moveFolder",a[b],d.proxy(function(d,e){b++;this.progressBar.incrementProcessedItemCount(1);this.progressBar.updateProgressBar();"success"==e&&g.push(d);b>=a.length?c(g):q(a,b,c)},this))},this);q(h,0,n);return}}else this._collapseExtraExpandedFolders();this._folderDrag.returnHelpersToDraggees()},
_performActualFolderMove:function(a,b,c,e,f){this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(1);this.progressBar.showProgressBar();var g=d.proxy(function(a,b,c){c=d();var e=d(),g;for(g in b)if(e=this._getSourceByFolderId(g),e=e.attr("data-key","folder:"+b[g].newId).data("key","folder:"+b[g].newId).parent(),0==c.length||0<c.parents().filter(e).length)c=e,topFolderMovedId=b[g].newId;if(0==c.length)this.setIndexAvailable(),this.progressBar.hideProgressBar(),this._folderDrag.returnHelpersToDraggees();
else{b=c.find(">a");g=c.siblings("ul, .toggle");var e=this._getParentSource(b),n=this._getSourceByFolderId(f);this._prepareParentForChildren(n);this._addSubfolder(n,c);b.after(g);this._cleanUpTree(e);this.$sidebar.find("ul>ul, ul>.toggle").remove();for(c=0;c<a.length;c++)Craft.postActionRequest("assets/deleteFolder",{folderId:a[c]});this.setIndexAvailable();this.progressBar.hideProgressBar();this._folderDrag.returnHelpersToDraggees();this._selectSourceByFolderId(topFolderMovedId)}},this);0<a.length?
this._moveFile(a,0,d.proxy(function(){g(b,c,e)},this)):g(b,c,e)},_getParentSource:function(a){return 1==a.parents("ul").length?null:a.parent().parent().siblings("a")},_moveFile:function(a,b,c){0==b&&(this.responseArray=[]);Craft.postActionRequest("assets/moveFile",a[b],d.proxy(function(d,f){this.progressBar.incrementProcessedItemCount(1);this.progressBar.updateProgressBar();"success"==f&&this.responseArray.push(d);b++;b>=a.length?c(this.responseArray):this._moveFile(a,b,c)},this))},_selectSourceByFolderId:function(a){a=
this._getSourceByFolderId(a);a.parent().parents("li").each(function(){d(this).hasClass("expanded")||d(this).find("> .toggle").click()});this.selectSource(a);this.updateElements()},onAfterHtmlInit:function(){this.$buttons||(this.$buttons=d('<div class="buttons"></div>').prependTo(this.$sidebar));this.$uploadButton||(this.$uploadButton=d('<div class="assets-upload"></div>').prependTo(this.$buttons));this.$progressBar||(this.$progressBar=d('<div class="assets-uploadprogress hidden"><div class="assets-progressbar"><div class="assets-pb-bar"></div></div></div>').appendTo(this.$main));
this.promptHandler=new Craft.PromptHandler;this.progressBar=new Craft.ProgressBar(this.$progressBar);var a={onSubmit:d.proxy(this,"_onUploadSubmit"),onProgress:d.proxy(this,"_onUploadProgress"),onComplete:d.proxy(this,"_onUploadComplete")};this.uploader=new Craft.Uploader(this.$uploadButton,a);this.base()},onSelectSource:function(){this.uploader.setParams({folderId:this._getFolderIdFromSourceKey(this.sourceKey)});this.base()},_getFolderIdFromSourceKey:function(a){return a.split(":")[1]},_onUploadSubmit:function(a){this.uploader.getInProgress()?
this._uploadTotalFiles++:(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar(),this._uploadFileProgress={},this._uploadedFileIds=[],this._uploadTotalFiles=1);this._uploadFileProgress[a]=0},_onUploadProgress:function(a,b,c,d){this._uploadFileProgress[a]=c/d;this._updateUploadProgress()},_updateUploadProgress:function(){var a=0,b;for(b in this._uploadFileProgress)a+=this._uploadFileProgress[b];a=Math.round(100*a/this._uploadTotalFiles)+"%";this.progressBar.setProgressPercentage(a)},
_onUploadComplete:function(a,b,c){this._uploadFileProgress[a]=1;this._updateUploadProgress();a=!0;c.success||c.prompt?(this._uploadedFileIds.push(c.fileId),c.prompt&&this.promptHandler.addPrompt(c)):(alert(Craft.t("Upload failed for {filename}",{filename:b})),a=!1);this.uploader.getInProgress()||(this.setIndexAvailable(),this.progressBar.hideProgressBar(),this.promptHandler.getPromptCount()?this.promptHandler.showBatchPrompts(d.proxy(this,"_uploadFollowup")):a&&this.updateElements())},_uploadFollowup:function(a){this.setIndexBusy();
this.progressBar.resetProgressBar();this.promptHandler.resetPrompts();var b=d.proxy(function(){this.setIndexBusy();this.progressBar.hideProgressBar();this.updateElements()},this);this.progressBar.setItemCount(a.length);var c=d.proxy(function(a,b,g){Craft.postActionRequest("assets/uploadFile",{additionalInfo:a[b].additionalInfo,fileName:a[b].fileName,userResponse:a[b].choice},d.proxy(function(d,k){"success"==k&&d.fileId&&this._uploadedFileIds.push(d.fileId);b++;this.progressBar.incrementProcessedItemCount(1);
this.progressBar.updateProgressBar();b==a.length?g():c(a,b,g)},this))},this);c(a,0,b)},onUpdateElements:function(a){this.base(a);"index"==this.settings.context&&($elements=this.$elementContainer.children(":not(.disabled)"),this._initElementSelect($elements),this._attachElementEvents($elements),this._initElementDragger($elements));if(this._uploadedFileIds.length){a=null;for(var b=0;b<this._uploadedFileIds.length;b++)a=this.$main.find("[data-id="+this._uploadedFileIds[b]+"]:first"),this.elementSelect.selectItem(a);
this._uploadedFileIds=[]}},_initElementSelect:function(a){"object"==typeof this.elementSelect&&null!=this.elementSelect&&(this.elementSelect.destroy(),delete this.elementSelect);a=new Garnish.Select(this.$elementContainer,a,{multi:!0,vertical:"table"==this.getSelectedSourceState("mode"),onSelectionChange:d.proxy(this,"_onElementSelectionChange")});this.setElementSelect(a)},_onElementSelectionChange:function(){this._enableElementContextMenu();var a=this.elementSelect.getSelectedItems();this._selectedFileIds=
[];for(var b=0;b<a.length;b++)this._selectedFileIds[b]=d(a[b]).attr("data-id")},_attachElementEvents:function(a){this.removeListener(a,"dlbclick");this.addListener(a,"dblclick",d.proxy(this,"_editProperties"));this._destroyElementContextMenus();this._createElementContextMenus(a)},_initElementDragger:function(a){this._fileDrag.removeAllItems();this._fileDrag.addItems(a)},_editProperties:function(a){a=d(a.currentTarget);"table"==this.getSelectedSourceState("mode")&&(a=a.find(".element"));if(!a.data("ElementEditor")){var b=
{elementId:a.attr("data-id"),$trigger:a,loadContentAction:"assets/editFileContent",saveContentAction:"assets/saveFileContent"};a.data("ElementEditor",new Craft.ElementEditor(b))}a.data("ElementEditor").show()},_createElementContextMenus:function(a){var b={menuClass:"menu assets-contextmenu"},c=[{label:Craft.t("View file"),onClick:d.proxy(this,"_viewFile")}];c.push({label:Craft.t("Edit properties"),onClick:d.proxy(this,"_showProperties")});c.push({label:Craft.t("Rename file"),onClick:d.proxy(this,
"_renameFile")});c.push({label:Craft.t("Copy reference tag"),onClick:d.proxy(this,"_copyRefTag")});c.push("-");c.push({label:Craft.t("Delete file"),onClick:d.proxy(this,"_deleteFile")});this._singleFileMenu=new Garnish.ContextMenu(a,c,b);c=[{label:Craft.t("Delete"),onClick:d.proxy(this,"_deleteFiles")}];this._multiFileMenu=new Garnish.ContextMenu(a,c,b);this._enableElementContextMenu()},_destroyElementContextMenus:function(){null!==this._singleFileMenu&&this._singleFileMenu.destroy();null!==this._multiFileMenu&&
this._singleFileMenu.destroy()},_enableElementContextMenu:function(){this._multiFileMenu.disable();this._singleFileMenu.disable();1==this.elementSelect.getTotalSelected()?this._singleFileMenu.enable():1<this.elementSelect.getTotalSelected()&&this._multiFileMenu.enable()},_showProperties:function(a){d(a.currentTarget).dblclick()},_viewFile:function(a){window.open(d(a.currentTarget).find("[data-url]").attr("data-url"))},_renameFile:function(a){var b=d(a.currentTarget);a=b.attr("data-id");var b=b.find("[data-url]").attr("data-url").split("/").pop(),
c=prompt(Craft.t("Rename file"),b);if(c&&c!=b){this.setIndexBusy();var e={fileId:a,folderId:this._getFolderIdFromSourceKey(this.$source.data("key")),fileName:c},f=function(a,b){this.setIndexAvailable();this.promptHandler.resetPrompts();if("success"==b){if(a.prompt){this.promptHandler.addPrompt(a);var c=d.proxy(function(a){a=a[0].choice;"cancel"!=a&&(e.action=a,Craft.postActionRequest("assets/moveFile",e,d.proxy(f,this)))},this);this.promptHandler.showBatchPrompts(c)}a.success&&this.updateElements();
a.error&&alert(a.error)}};Craft.postActionRequest("assets/moveFile",e,d.proxy(f,this))}},_copyRefTag:function(a){var b=Craft.t("{ctrl}C to copy.",{ctrl:navigator.appVersion.indexOf("Mac")?"\u2318":"Ctrl-"});prompt(b,"{asset:"+d(a.currentTarget).data("id")+"}")},_deleteFile:function(a){a=d(a.currentTarget);var b=a.attr("data-id"),c=a.attr("data-label");confirm(Craft.t("Are you sure you want to delete \u201c{name}\u201d?",{name:c}))&&(a.data("AssetEditor")&&a.data("AssetEditor").removeHud(),this.setIndexBusy(),
Craft.postActionRequest("assets/deleteFile",{fileId:b},d.proxy(function(a,b){this.setIndexAvailable();"success"==b&&(a.error&&alert(a.error),this.updateElements())},this)))},_deleteFiles:function(){if(confirm(Craft.t("Are you sure you want to delete these {number} files?",{number:this.elementSelect.getTotalSelected()}))){this.setIndexBusy();for(var a={},b=0;b<this._selectedFileIds.length;b++)a["fileId["+b+"]"]=this._selectedFileIds[b];Craft.postActionRequest("assets/deleteFile",a,d.proxy(function(a,
b){this.setIndexAvailable();"success"==b&&(a.error&&alert(a.error),this.updateElements())},this))}},_getDragHelper:function(a){switch(this.getSelectedSourceState("mode")){case "table":var b=d('<div class="assets-listview assets-lv-drag" />'),c=d('<table cellpadding="0" cellspacing="0" border="0" />').appendTo(b),e=d("<tbody />").appendTo(c);c.width(this.$table.width());e.append(a);return b;case "thumbs":return d('<ul class="thumbsview assets-tv-drag" />').append(a.removeClass("sel"))}return d()},
_onDropTargetChange:function(a){clearTimeout(this._expandDropTargetFolderTimeout);a&&((a=this._getFolderIdFromSourceKey(a.data("key")))?(this.dropTargetFolder=this._getSourceByFolderId(a),this._hasSubfolders(this.dropTargetFolder)&&!this._isExpanded(this.dropTargetFolder)&&(this._expandDropTargetFolderTimeout=setTimeout(d.proxy(this,"_expandFolder"),500))):this.dropTargetFolder=null)},_collapseExtraExpandedFolders:function(a){clearTimeout(this._expandDropTargetFolderTimeout);if(a)var b=this._getSourceByFolderId(a).parents("li").find(">a");
for(var c=this._tempExpandedFolders.length-1;0<=c;c--){var d=this._tempExpandedFolders[c];a&&0!=b.filter('[data-key="'+d.data("key")+'"]').length||(this._collapseFolder(d),this._tempExpandedFolders.splice(c,1))}},_getSourceByFolderId:function(a){return this.$sources.filter('[data-key="folder:'+a+'"]')},_hasSubfolders:function(a){return a.siblings("ul").find("li").length},_isExpanded:function(a){return a.parent("li").hasClass("expanded")},_expandFolder:function(){this._collapseExtraExpandedFolders(this._getFolderIdFromSourceKey(this.dropTargetFolder.data("key")));
this.dropTargetFolder.parent().find("> .toggle").click();this._tempExpandedFolders.push(this.dropTargetFolder)},_collapseFolder:function(a){a=a.parent();a.hasClass("expanded")&&a.find("> .toggle").click()},_createFolderContextMenu:function(a){a=d(a);var b=[{label:Craft.t("New subfolder"),onClick:d.proxy(this,"_createSubfolder",a)}];1<a.parents("ul").length&&(b.push({label:Craft.t("Rename folder"),onClick:d.proxy(this,"_renameFolder",a)}),b.push({label:Craft.t("Delete folder"),onClick:d.proxy(this,
"_deleteFolder",a)}));new Garnish.ContextMenu(a,b,{menuClass:"menu assets-contextmenu"})},_createSubfolder:function(a){var b=prompt(Craft.t("Enter the name of the folder"));b&&(b={parentId:this._getFolderIdFromSourceKey(a.data("key")),folderName:b},this.setIndexBusy(),Craft.postActionRequest("assets/createFolder",b,d.proxy(function(b,e){this.setIndexAvailable();if("success"==e&&b.success){this._prepareParentForChildren(a);var f=d('<li><a data-key="folder:'+b.folderId+'" data-has-thumbs="'+a.data("has-thumbs")+
'">'+b.folderName+"</a></li>"),g=f.find("a");this._addSubfolder(a,f);this._createFolderContextMenu(g);this.sourceSelect.addItems(g);this._folderDrag.addItems(g.parent());this.$sources=this.$sources.add(g)}"success"==e&&b.error&&alert(b.error)},this)))},_deleteFolder:function(a){if(confirm(Craft.t("Really delete folder \u201c{folder}\u201d?",{folder:d.trim(a.text())}))){var b={folderId:this._getFolderIdFromSourceKey(a.data("key"))};this.setIndexBusy();Craft.postActionRequest("assets/deleteFolder",
b,d.proxy(function(b,d){this.setIndexAvailable();if("success"==d&&b.success){var f=this._getParentSource(a);this.$sources=this.$sources.not(a);this.sourceSelect.removeItems(a);a.parent().remove();this._cleanUpTree(f)}"success"==d&&b.error&&alert(b.error)},this))}},_renameFolder:function(a){var b=d.trim(a.text()),c=prompt(Craft.t("Rename folder"),b);c&&c!=b&&(b={folderId:this._getFolderIdFromSourceKey(a.data("key")),newName:c},this.setIndexBusy(),Craft.postActionRequest("assets/renameFolder",b,d.proxy(function(b,
c){this.setIndexAvailable();"success"==c&&b.success&&a.text(b.newName);"success"==c&&b.error&&alert(b.error)},this),"json"))},_prepareParentForChildren:function(a){this._hasSubfolders(a)||(a.parent().addClass("expanded").append('<div class="toggle"></div><ul></ul>'),this.addListener(a.siblings(".toggle"),"click",function(a){d(a.currentTarget).parent().toggleClass("expanded")}))},_addSubfolder:function(a,b){var c=!1;a.siblings("ul").find("li").each(function(){!c&&d.trim(d(this).text())>d.trim(b.text())&&
(d(this).before(b),c=!0)});c||a.siblings("ul").append(b)},_cleanUpTree:function(a){null!==a&&0==a.siblings("ul").find("li").length&&(a.siblings("ul").remove(),a.siblings(".toggle").remove(),a.parent().removeClass("expanded"))}});Craft.registerElementIndexClass("Asset",Craft.AssetIndex);Craft.AssetSelectInput=Craft.BaseElementSelectInput.extend({requestId:0,hud:null,init:function(a,b,c,d,f,g,h,k){this.base(a,b,c,d,f,g,h,k);this._attachHUDEvents()},selectElements:function(a){this.base(a);this._attachHUDEvents()},
_attachHUDEvents:function(){this.removeListener(this.$elements,"dlbclick");this.addListener(this.$elements,"dblclick",d.proxy(this,"_editProperties"))},_editProperties:function(a){a=d(a.currentTarget);if(!a.data("ElementEditor")){var b={elementId:a.attr("data-id"),$trigger:a,loadContentAction:"assets/editFileContent",saveContentAction:"assets/saveFileContent"};a.data("ElementEditor",new Craft.ElementEditor(b))}a.data("ElementEditor").show()}});Craft.AssetSelectorModal=Craft.BaseElementSelectorModal.extend({$selectTransformBtn:null,
$transformSpinner:null,_selectedTransform:null,init:function(a,b){b=d.extend({},Craft.AssetSelectorModal.defaults,b);if(b.canSelectImageTransforms&&"undefined"==typeof Craft.AssetSelectorModal.transforms){var c=this.base;this.fetchTransformInfo(d.proxy(function(){c.call(this,a,b);this.createSelectTransformButton()},this))}else this.base(a,b),b.canSelectImageTransforms&&this.createSelectTransformButton()},fetchTransformInfo:function(a){Craft.postActionRequest("assets/getTransformInfo",d.proxy(function(b,
c){Craft.AssetSelectorModal.transforms="success"==c&&b instanceof Array?b:[];a()},this))},createSelectTransformButton:function(){if(Craft.AssetSelectorModal.transforms.length){var a=d('<div class="btngroup"/>').appendTo(this.$buttons);this.$selectBtn.appendTo(a);this.$selectTransformBtn=d('<div class="btn menubtn disabled">'+Craft.t("Select Transform")+"</div>").appendTo(a);for(var b=d('<div class="menu" data-align="right"></div>').insertAfter(this.$selectTransformBtn),b=d("<ul></ul>").appendTo(b),
c=0;c<Craft.AssetSelectorModal.transforms.length;c++)d('<li><a data-transform="'+Craft.AssetSelectorModal.transforms[c].handle+'">'+Craft.AssetSelectorModal.transforms[c].name+"</a></li>").appendTo(b);new Garnish.MenuBtn(this.$selectTransformBtn,{onOptionSelect:d.proxy(this,"onSelectTransform")});this.$transformSpinner=d('<div class="spinner hidden" style="margin-right: -24px;"/>').insertAfter(a)}},onSelectionChange:function(a){if(this.elementSelect.totalSelected&&this.settings.canSelectImageTransforms&&
Craft.AssetSelectorModal.transforms.length){a=!0;for(var b=this.elementSelect.getSelectedItems(),c=0;c<b.length;c++)if(!d(".element.hasthumb:first",b[c]).length){a=!1;break}}else a=!1;a?this.$selectTransformBtn.removeClass("disabled"):this.$selectTransformBtn&&this.$selectTransformBtn.addClass("disabled");this.base()},onSelectTransform:function(a){a=d(a).data("transform");this.selectImagesWithTransform(a)},selectImagesWithTransform:function(a){"undefined"==typeof Craft.AssetSelectorModal.transformUrls[a]&&
(Craft.AssetSelectorModal.transformUrls[a]={});for(var b=this.elementSelect.getSelectedItems(),c=[],e=0;e<b.length;e++){var f=d(b[e]).data("id");"undefined"==typeof Craft.AssetSelectorModal.transformUrls[a][f]&&c.push(f)}c.length?(this.$transformSpinner.removeClass("hidden"),this.fetchMissingTransformUrls(c,a,d.proxy(function(){this.$transformSpinner.addClass("hidden");this.selectImagesWithTransform(a)},this))):(this._selectedTransform=a,this.selectElements(),this._selectedTransform=null)},fetchMissingTransformUrls:function(a,
b,c){var e=a.pop();Craft.postActionRequest("assets/generateTransform",{fileId:e,handle:b},d.proxy(function(d,g){Craft.AssetSelectorModal.transformUrls[b][e]=!1;"success"==g&&"success"==d.split(":")[0]&&(Craft.AssetSelectorModal.transformUrls[b][e]=d.replace(/^success:/,""));a.length?this.fetchMissingTransformUrls(a,b,c):c()},this))},getElementInfo:function(a){a=this.base(a);if(this._selectedTransform)for(var b=0;b<a.length;b++){var c=a[b].id;"undefined"!=typeof Craft.AssetSelectorModal.transformUrls[this._selectedTransform][c]&&
!1!==Craft.AssetSelectorModal.transformUrls[this._selectedTransform][c]&&(a[b].url=Craft.AssetSelectorModal.transformUrls[this._selectedTransform][c])}return a},onSelect:function(a){this.settings.onSelect(a,this._selectedTransform)}},{defaults:{canSelectImageTransforms:!1},transformUrls:{}});Craft.registerElementSelectorModalClass("Asset",Craft.AssetSelectorModal);Craft.DataTableSorter=Garnish.DragSort.extend({$table:null,init:function(a,b){this.$table=d(a);var c=this.$table.children("tbody").children(":not(.filler)");
b=d.extend({},Craft.DataTableSorter.defaults,b);b.container=this.$table.children("tbody");b.helper=d.proxy(this,"getHelper");b.caboose="<tr/>";b.axis=Garnish.Y_AXIS;this.base(c,b)},getHelper:function(a){var b=d('<div class="'+this.settings.helperClass+'"/>').appendTo(Garnish.$bod),c=d("<table/>").appendTo(b),e=d("<tbody/>").appendTo(c);a.appendTo(e);c.width(this.$table.width());c.prop("className",this.$table.prop("className"));c=this.$table.find("tr:first").children();a=a.children();for(e=0;e<a.length;e++)d(a[e]).width(d(c[e]).width());
return b}},{defaults:{handle:".move",helperClass:"datatablesorthelper"}});Craft.EditableTable=Garnish.Base.extend({id:null,baseName:null,columns:null,sorter:null,biggestId:-1,$table:null,$tbody:null,$addRowBtn:null,init:function(a,b,c,e){this.id=a;this.baseName=b;this.columns=c;this.setSettings(e,Craft.EditableTable.defaults);this.$table=d("#"+a);this.$tbody=this.$table.children("tbody");this.sorter=new Craft.DataTableSorter(this.$table,{helperClass:"editabletablesorthelper"});a=this.$tbody.children();
for(b=0;b<a.length;b++)new Craft.EditableTable.Row(this,a[b]);this.$addRowBtn=this.$table.next(".add");this.addListener(this.$addRowBtn,"activate","addRow")},addRow:function(){var a=Craft.EditableTable.getRowHtml(this.settings.rowIdPrefix+(this.biggestId+1),this.columns,this.baseName,{}),a=d(a).appendTo(this.$tbody);new Craft.EditableTable.Row(this,a);this.sorter.addItems(a);a.find("input,textarea,select").first().focus();this.settings.onAddRow(a)}},{textualColTypes:["singleline","multiline","number"],
defaults:{rowIdPrefix:"",onAddRow:d.noop,onDeleteRow:d.noop},getRowHtml:function(a,b,c,d){var f='<tr data-id="'+a+'">',g;for(g in b){var h=b[g],k=c+"["+a+"]["+g+"]",m="undefined"!=typeof d[g]?d[g]:"",l=Craft.inArray(h.type,Craft.EditableTable.textualColTypes),f=f+('<td class="'+(l?"textual":"")+" "+("undefined"!=typeof h["class"]?h["class"]:"")+'"'+("undefined"!=typeof h.width?' width="'+h.width+'"':"")+">");switch(h.type){case "select":var f=f+('<div class="select small"><select name="'+k+'">'),
k=!1,p;for(p in h.options)if(l=h.options[p],"undefined"!=typeof l.optgroup)k?f+="</optgroup>":k=!0,f+='<optgroup label="'+l.optgroup+'">';else var n="undefined"!=typeof l.value?l.value:p,f=f+('<option value="'+n+'"'+(n==m?" selected":"")+("undefined"!=typeof l.disabled&&l.disabled?" disabled":"")+">"+("undefined"!=typeof l.label?l.label:l)+"</option>");k&&(f+="</optgroup>");f+="</select></div>";break;case "checkbox":f+='<input type="hidden" name="'+k+'"><input type="checkbox" name="'+k+'" value="1"'+
(m?" checked":"")+">";break;default:f+='<textarea name="'+k+'" rows="1">'+m+"</textarea>"}f+="</td>"}return f+='<td class="thin action"><a class="move icon" title="'+Craft.t("Reorder")+'"></a></td><td class="thin action"><a class="delete icon" title="'+Craft.t("Delete")+'"></a></td></tr>'}});Craft.EditableTable.Row=Garnish.Base.extend({table:null,id:null,niceTexts:null,$tr:null,$tds:null,$textareas:null,$deleteBtn:null,init:function(a,b){this.table=a;this.$tr=d(b);this.$tds=this.$tr.children();var c=
parseInt(this.$tr.attr("data-id").substr(this.table.settings.rowIdPrefix.length));c>this.table.biggestId&&(this.table.biggestId=c);this.$textareas=d();this.niceTexts=[];var c={},e=0,f;for(f in this.table.columns){var g=this.table.columns[f];Craft.inArray(g.type,Craft.EditableTable.textualColTypes)&&($textarea=d("textarea",this.$tds[e]),this.$textareas=this.$textareas.add($textarea),this.addListener($textarea,"focus","onTextareaFocus"),this.addListener($textarea,"mousedown","ignoreNextTextareaFocus"),
this.niceTexts.push(new Garnish.NiceText($textarea,{onHeightChange:d.proxy(this,"onTextareaHeightChange")})),"singleline"!=g.type&&"number"!=g.type||this.addListener($textarea,"keypress",{type:g.type},"validateKeypress"),c[f]=$textarea);e++}this.onTextareaHeightChange();for(f in this.table.columns)g=this.table.columns[f],g.autopopulate&&"undefined"!=typeof c[g.autopopulate]&&!c[f].val()&&("handle"==g.autopopulate?new Craft.HandleGenerator(c[f],c[g.autopopulate]):new Craft.BaseInputGenerator(c[f],
c[g.autopopulate]));f=this.$tr.children().last().find(".delete");this.addListener(f,"click","deleteRow")},onTextareaFocus:function(a){var b=d(a.currentTarget);b.data("ignoreNextFocus")?b.data("ignoreNextFocus",!1):setTimeout(function(){var a=b.val();"undefined"!=typeof b[0].setSelectionRange?b[0].setSelectionRange(0,2*a.length):b.val(a)},0)},ignoreNextTextareaFocus:function(a){d.data(a.currentTarget,"ignoreNextFocus",!0)},validateKeypress:function(a){var b=a.keyCode?a.keyCode:a.charCode;a.metaKey||
a.ctrlKey||b!=Garnish.RETURN_KEY&&("number"!=a.data.type||Craft.inArray(b,Craft.EditableTable.Row.numericKeyCodes))||a.preventDefault()},onTextareaHeightChange:function(){for(var a=-1,b=0;b<this.niceTexts.length;b++)this.niceTexts[b].height>a&&(a=this.niceTexts[b].height);this.$textareas.css("min-height",a)},deleteRow:function(){this.table.sorter.removeItems(this.$tr);this.$tr.remove();this.table.settings.onDeleteRow(this.$tr)}},{numericKeyCodes:[9,8,37,38,39,40,45,91,46,190,48,49,50,51,52,53,54,
55,56,57]});Craft.ElementEditor=Garnish.Base.extend({hud:null,elementId:0,requestId:0,$trigger:null,$spinner:null,init:function(a){this.setSettings(a,Craft.ElementEditor.defaults);this.elementId=this.settings.elementId;this.$trigger=this.settings.$trigger},show:function(){var a={requestId:++this.requestId,elementId:this.elementId};this._showSpinner();Craft.postActionRequest(this.settings.loadContentAction,a,d.proxy(function(a,c){this._hideSpinner();"success"==c&&a.requestId==this.requestId&&($hudHtml=
d("<div/>").html((a.headHtml?a.headHtml:"")+(a.bodyHtml?a.bodyHtml:"")+(a.footHtml?a.footHtml:"")),this.hud=new Garnish.HUD(this.$trigger,$hudHtml,{hudClass:"hud contenthud",triggerSpacing:10,tipWidth:30,closeOtherHUDs:!1}),Craft.initUiElements($hudHtml),this.addListener($hudHtml.find("form"),"submit",d.proxy(this,"_saveElementDetails")),this.addListener($hudHtml.find(".btn.cancel"),"click",d.proxy(this,"removeHud")))},this))},_saveElementDetails:function(a){a.preventDefault();this.hud.$body.find(".spinner").removeClass("hidden");
$form=d(a.currentTarget);a=$form.serialize();Craft.postActionRequest(this.settings.saveContentAction,a,d.proxy(function(a,c){this.hud.$body.find(".spinner").addClass("hidden");"success"==c&&("success"==c&&a.success?(this.$trigger.find(".label").text(a.title),"undefined"!=typeof Craft.entryPreviewMode&&Craft.entryPreviewMode.updateIframe(!0),this.removeHud()):Garnish.shake(this.hud.$hud))},this))},_showSpinner:function(){this.removeHud();this.$trigger.find(".delete").addClass("hidden");this.$trigger.hasClass("removable")&&
this.$trigger.removeClass("removable").data("elementInputField",!0);this.$trigger.find(".label").css("padding-right","20px");this.$trigger.find(".label").after('<div class="spinner element-spinner" style="position: absolute; right: 2px; bottom: -1px;"></div>')},_hideSpinner:function(){this.$trigger.find(".delete").removeClass("hidden");this.$trigger.find(".label").removeClass("spinner element-spinner inline").html(this.$trigger.find(".label nobr").html());this.$trigger.data("elementInputField")&&
this.$trigger.addClass("removable");this.$trigger.find(".label").css("padding-right","0");this.$trigger.find(".label").siblings(".spinner").remove()},removeHud:function(){null!==this.hud&&(this.hud.hide(),delete this.hud)}},{defaults:{elementId:null,$trigger:null,loadContentAction:null,saveContentAction:null}});Craft.EntryIndex=Craft.BaseElementIndex.extend({getDefaultSourceKey:function(){if("index"==this.settings.context&&"undefined"!=typeof defaultSectionHandle){if("singles"==defaultSectionHandle)return"singles";
for(var a=0;a<this.$sources.length;a++){var b=d(this.$sources[a]);if(b.data("handle")==defaultSectionHandle)return b.data("key")}}return this.base()},onSelectSource:function(){if("index"==this.settings.context&&"undefined"!=typeof history){var a="singles"==this.$source.data("key")?"singles":this.$source.data("handle"),b="entries";a&&(b+="/"+a);history.replaceState({},"",Craft.getUrl(b))}this.base()}});Craft.registerElementIndexClass("Entry",Craft.EntryIndex);Craft.EntryUrlFormatGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(a){a=
a.replace("/<(.*?)>/g","");a=a.toLowerCase();a=Craft.asciiString(a);a=a.replace(/^[^a-z]+/,"");a=a.replace(/[^a-z0-9]+$/,"");(a=Craft.filterArray(a.split(/[^a-z0-9]+/)).join("-"))&&this.settings.suffix&&(a+=this.settings.suffix);return a}});Craft.FieldLayoutDesigner=Garnish.Base.extend({$container:null,$tabContainer:null,$unusedFieldContainer:null,$newTabBtn:null,$allFields:null,tabGrid:null,unusedFieldGrid:null,tabDrag:null,fieldDrag:null,init:function(a,b){this.$container=d(a);this.setSettings(b,
Craft.FieldLayoutDesigner.defaults);this.$tabContainer=this.$container.children(".fld-tabs");this.$unusedFieldContainer=this.$container.children(".unusedfields");this.$newTabBtn=d("#newtabbtn");this.$allFields=this.$unusedFieldContainer.find(".fld-field");this.tabGrid=new Craft.Grid(this.$tabContainer,Craft.FieldLayoutDesigner.gridSettings);this.unusedFieldGrid=new Craft.Grid(this.$unusedFieldContainer,Craft.FieldLayoutDesigner.gridSettings);for(var c=this.$tabContainer.children(),e=0;e<c.length;e++)this.initTab(d(c[e]));
this.fieldDrag=new Craft.FieldLayoutDesigner.FieldDrag(this);this.settings.customizableTabs&&(this.tabDrag=new Craft.FieldLayoutDesigner.TabDrag(this),this.addListener(this.$newTabBtn,"activate","addTab"))},initTab:function(a){if(this.settings.customizableTabs){var b=a.find(".tabs .settings"),c=d('<div class="menu" data-align="center"/>').insertAfter(b),c=d("<ul/>").appendTo(c);d('<li><a data-action="rename">'+Craft.t("Rename")+"</a></li>").appendTo(c);d('<li><a data-action="delete">'+Craft.t("Delete")+
"</a></li>").appendTo(c);new Garnish.MenuBtn(b,{onOptionSelect:d.proxy(this,"onTabOptionSelect")})}a=a.children(".fld-tabcontent").children();for(b=0;b<a.length;b++)this.initField(d(a[b]))},initField:function(a){var b=a.find(".settings"),c=d('<div class="menu" data-align="center"/>').insertAfter(b),c=d("<ul/>").appendTo(c);a.hasClass("fld-required")?d('<li><a data-action="toggle-required">'+Craft.t("Make not required")+"</a></li>").appendTo(c):d('<li><a data-action="toggle-required">'+Craft.t("Make required")+
"</a></li>").appendTo(c);d('<li><a data-action="remove">'+Craft.t("Remove")+"</a></li>").appendTo(c);new Garnish.MenuBtn(b,{onOptionSelect:d.proxy(this,"onFieldOptionSelect")})},onTabOptionSelect:function(a){if(this.settings.customizableTabs){a=d(a);var b=a.data("menu").$trigger.parent().parent().parent();switch(a.data("action")){case "rename":this.renameTab(b);break;case "delete":this.deleteTab(b)}}},onFieldOptionSelect:function(a){a=d(a);var b=a.data("menu").$trigger.parent();switch(a.data("action")){case "toggle-required":this.toggleRequiredField(b,
a);break;case "remove":this.removeField(b)}},renameTab:function(a){if(this.settings.customizableTabs){var b=a.find(".tabs .tab span"),c=b.text(),d=prompt(Craft.t("Give your tab a name."),c);d&&d!=c&&(b.text(d),a.find(".id-input").attr("name","fieldLayout["+Craft.encodeUriComponent(d)+"][]"))}},deleteTab:function(a){if(this.settings.customizableTabs){for(var b=a.find(".fld-field"),c=0;c<b.length;c++){var e=d(b[c]).attr("data-id");this.removeFieldById(e)}this.tabGrid.removeItems(a);this.tabDrag.removeItems(a);
a.remove()}},toggleRequiredField:function(a,b){a.hasClass("fld-required")?(a.removeClass("fld-required"),a.find(".required-input").remove(),setTimeout(function(){b.text(Craft.t("Make required"))},500)):(a.addClass("fld-required"),d('<input class="required-input" type="hidden" name="requiredFields[]" value="'+a.data("id")+'">').appendTo(a),setTimeout(function(){b.text(Craft.t("Make not required"))},500))},removeField:function(a){var b=a.attr("data-id");a.remove();this.removeFieldById(b);this.tabGrid.refreshCols()},
removeFieldById:function(a){a=this.$allFields.filter("[data-id="+a+"]:first");var b=a.closest(".fld-tab");a.removeClass("hidden");b.hasClass("hidden")?(b.removeClass("hidden"),this.unusedFieldGrid.addItems(b),this.settings.customizableTabs&&this.tabDrag.addItems(b)):this.unusedFieldGrid.refreshCols()},addTab:function(){if(this.settings.customizableTabs){var a=d('<div class="fld-tab"><div class="tabs"><div class="tab sel draggable"><span>Tab '+(this.tabGrid.$items.length+1)+'</span><a class="settings icon" title="'+
Craft.t("Rename")+'"></a></div></div><div class="fld-tabcontent"></div></div>').appendTo(this.$tabContainer);this.tabGrid.addItems(a);this.tabDrag.addItems(a);this.initTab(a)}}},{gridSettings:{minColWidth:240,percentageWidths:!1,fillMode:"grid",snapToGrid:30},defaults:{customizableTabs:!0}});Craft.FieldLayoutDesigner.BaseDrag=Garnish.Drag.extend({designer:null,$insertion:null,showingInsertion:!1,$caboose:null,draggingUnusedItem:!1,addToTabGrid:!1,init:function(a,b){this.designer=a;var c=this.designer.$tabContainer.find(this.itemSelector).add(this.designer.$unusedFieldContainer.find(this.itemSelector));
this.base(c,b)},onDragStart:function(){this.base();this.draggingUnusedItem=this.$draggee.hasClass("unused");this.$insertion=this.getInsertion();this.addCaboose();this.$items=d().add(this.$items.add(this.$caboose));this.addToTabGrid&&this.designer.tabGrid.addItems(this.$caboose);this.draggingUnusedItem?this.showingInsertion=!1:(this.$insertion.insertBefore(this.$draggee),this.$draggee.detach(),this.$items=d().add(this.$items.not(this.$draggee).add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid&&
(this.designer.tabGrid.removeItems(this.$draggee),this.designer.tabGrid.addItems(this.$insertion)));this.setMidpoints()},addCaboose:d.noop,getItemContainer:d.noop,isItemInTabContainer:function(a){return this.getItemContainer(a)[0]==this.designer.$tabContainer[0]},setMidpoints:function(){for(var a=0;a<this.$items.length;a++){var b=d(this.$items[a]);if(this.isItemInTabContainer(b)){var c=b.offset();b.data("midpoint",{left:c.left+b.outerWidth()/2,top:c.top+b.outerHeight()/2})}}},onDrag:function(){this.draggingUnusedItem&&
!Garnish.hitTest(this.mouseX,this.mouseY,this.designer.$tabContainer)?this.showingInsertion&&(this.$insertion.remove(),this.$items=d().add(this.$items.not(this.$insertion)),this.showingInsertion=!1,this.addToTabGrid?this.designer.tabGrid.removeItems(this.$insertion):this.designer.tabGrid.refreshCols(),this.setMidpoints()):(this.onDrag._closestItem=this.getClosestItem(),this.onDrag._closestItem!=this.$insertion[0]&&(this.showingInsertion&&d.inArray(this.$insertion[0],this.$items)<d.inArray(this.onDrag._closestItem,
this.$items)&&-1==d.inArray(this.onDrag._closestItem,this.$caboose)?this.$insertion.insertAfter(this.onDrag._closestItem):this.$insertion.insertBefore(this.onDrag._closestItem),this.$items=d().add(this.$items.add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid?this.designer.tabGrid.addItems(this.$insertion):this.designer.tabGrid.refreshCols(),this.setMidpoints()));this.base()},getClosestItem:function(){this.getClosestItem._closestItem=null;this.getClosestItem._closestItemMouseDiff=null;
for(this.getClosestItem._i=0;this.getClosestItem._i<this.$items.length;this.getClosestItem._i++)if(this.getClosestItem._$item=d(this.$items[this.getClosestItem._i]),this.isItemInTabContainer(this.getClosestItem._$item)&&(this.getClosestItem._midpoint=this.getClosestItem._$item.data("midpoint"),this.getClosestItem._mouseDiff=Garnish.getDist(this.getClosestItem._midpoint.left,this.getClosestItem._midpoint.top,this.mouseX,this.mouseY),null===this.getClosestItem._closestItem||this.getClosestItem._mouseDiff<
this.getClosestItem._closestItemMouseDiff))this.getClosestItem._closestItem=this.getClosestItem._$item[0],this.getClosestItem._closestItemMouseDiff=this.getClosestItem._mouseDiff;return this.getClosestItem._closestItem},onDragStop:function(){this.showingInsertion&&(this.$insertion.replaceWith(this.$draggee),this.$items=d().add(this.$items.not(this.$insertion).add(this.$draggee)),this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$insertion),this.designer.tabGrid.addItems(this.$draggee)));
this.$items=this.$items.not(this.$caboose);this.$caboose.remove();this.addToTabGrid&&this.designer.tabGrid.removeItems(this.$caboose);this.$draggee.css({display:this.draggeeDisplay,visibility:"hidden"});this.designer.tabGrid.refreshCols();this.designer.unusedFieldGrid.refreshCols();this.returnHelpersToDraggees();this.base()}});Craft.FieldLayoutDesigner.TabDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab",addToTabGrid:!0,init:function(a){this.base(a,{handle:".tab"})},addCaboose:function(){this.$caboose=
d('<div class="fld-tab fld-tab-caboose"/>').appendTo(this.designer.$tabContainer)},getInsertion:function(){var a=this.$draggee.find(".tab");return d('<div class="fld-tab fld-insertion" style="height: '+this.$draggee.height()+'px;"><div class="tabs"><div class="tab sel draggable" style="width: '+a.width()+"px; height: "+a.height()+'px;"></div></div><div class="fld-tabcontent" style="height: '+this.$draggee.find(".fld-tabcontent").height()+'px;"></div></div>')},getItemContainer:function(a){return a.parent()},
onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var a=this.$draggee.clone().removeClass("unused"),b=a.find(".tab span").text();a.find(".fld-field").removeClass("unused");a.find(".tabs .tab").append('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');var c=a.find(".fld-field"),e=c.filter(".hidden").remove(),c=c.not(e);c.prepend('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');for(e=0;e<c.length;e++){var f=d(c[e]);f.append('<input class="id-input" type="hidden" name="fieldLayout['+
Craft.encodeUriComponent(b)+'][]" value="'+f.data("id")+'">')}this.designer.fieldDrag.addItems(c);this.designer.initTab(a);this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden");this.$draggee.find(".fld-field").addClass("hidden");this.$draggee=a;this.addItems(a);this.designer.tabGrid.addItems(a);this.designer.unusedFieldGrid.removeItems(this.$draggee)}this.base()}});Craft.FieldLayoutDesigner.FieldDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab .fld-field",
addCaboose:function(){this.$caboose=d();for(var a=this.designer.$tabContainer.children().children(".fld-tabcontent"),b=0;b<a.length;b++){var c=d('<div class="fld-tab fld-tab-caboose"/>').appendTo(a[b]);this.$caboose=this.$caboose.add(c)}},getInsertion:function(){return d('<div class="fld-field fld-insertion" style="height: '+this.$draggee.height()+'px;"/>')},getItemContainer:function(a){return a.parent().parent().parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var a=
this.$draggee.clone().removeClass("unused");a.prepend('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');this.designer.initField(a);this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden");if(0==this.$draggee.siblings(":not(.hidden)").length){var b=this.$draggee.parent().parent();b.addClass("hidden");this.designer.unusedFieldGrid.removeItems(b)}this.$draggee=a;this.addItems(a)}this.showingInsertion&&(a=this.$insertion.parent().parent().find(".tab span").text(),a="fieldLayout["+
Craft.encodeUriComponent(a)+"][]",this.draggingUnusedItem?this.$draggee.append('<input class="id-input" type="hidden" name="'+a+'" value="'+this.$draggee.data("id")+'">'):this.$draggee.find(".id-input").attr("name",a));this.base()}});Craft.FieldToggle=Garnish.Base.extend({$toggle:null,reverse:null,targetPrefix:null,_$target:null,type:null,init:function(a){this.$toggle=d(a);this.$toggle.data("fieldtoggle")&&(Garnish.log("Double-instantiating a field toggle on an element"),this.$toggle.data("fieldtoggle").destroy());
this.$toggle.data("fieldtoggle",this);this.type=this.getType();this.reverse=!!this.$toggle.attr("data-reverse-toggle");"select"==this.type&&(this.targetPrefix=this.$toggle.attr("data-target-prefix")||"",this.findTarget());"link"==this.type?this.addListener(this.$toggle,"click","onToggleChange"):this.addListener(this.$toggle,"change","onToggleChange")},getType:function(){if("INPUT"==this.$toggle.prop("nodeName")&&"checkbox"==this.$toggle.attr("type").toLowerCase())return"checkbox";if("SELECT"==this.$toggle.prop("nodeName"))return"select";
if("A"==this.$toggle.prop("nodeName"))return"link"},getTarget:function(){this._$target||this.findTarget();return this._$target},findTarget:function(){if("select"==this.type)this._$target=d("#"+this.targetPrefix+this.getToggleVal());else{var a=this.$toggle.data("target");a.match(/^[#\.]/)||(a="#"+a);this._$target=d(a)}},getToggleVal:function(){return Garnish.getInputPostVal(this.$toggle)},onToggleChange:function(){if("select"==this.type)this.hideTarget(),this.findTarget(),this.showTarget();else{var a=
"link"==this.type?this.$toggle.hasClass("collapsed"):!!this.getToggleVal();this.reverse&&(a=!a);a?this.showTarget():this.hideTarget()}},showTarget:function(){if(this.getTarget().length&&(this.getTarget().removeClass("hidden"),"select"!=this.type)){"link"==this.type&&(this.$toggle.removeClass("collapsed"),this.$toggle.addClass("expanded"));var a=this.getTarget();a.height("auto");var b=a.height();a.height(0);a.stop().animate({height:b},"fast",d.proxy(function(){a.height("auto")},this))}},hideTarget:function(){this.getTarget().length&&
("select"==this.type?this.getTarget().addClass("hidden"):("link"==this.type&&(this.$toggle.removeClass("expanded"),this.$toggle.addClass("collapsed")),this.getTarget().stop().animate({height:0},"fast",d.proxy(function(){this.getTarget().addClass("hidden")},this))))}});Craft.Grid=Garnish.Base.extend({$container:null,$items:null,items:null,totalCols:null,cols:null,colWidth:null,init:function(a,b){this.$container=d(a);this.setSettings(b,Craft.Grid.defaults);this.$items=this.$container.children(this.settings.itemSelector);
this.setCols();this.addListener(Garnish.$win,"resize","setCols")},addItems:function(a){this.$items=d().add(this.$items.add(a));this.refreshCols()},removeItems:function(a){this.$items=d().add(this.$items.not(a));this.refreshCols()},setCols:function(){var a=Math.floor(this.$container.width()/this.settings.minColWidth);0==a&&(a=1);return a!==this.totalCols?(this.totalCols=a,this.refreshCols(),!0):!1},refreshCols:function(){if("grid"==this.settings.fillMode)for(var a=0;a<this.$items.length;){for(var b=
-1,c=0,e=a;e<a+this.totalCols&&e<this.$items.length;e++){var f=d(this.$items[e]).height("auto").height();f>b&&(b=f);c++}this.settings.snapToGrid&&(c=b%this.settings.snapToGrid)&&(b+=this.settings.snapToGrid-c);for(e=a;e<a+this.totalCols&&e<this.$items.length;e++)d(this.$items[e]).height(b);a+=this.totalCols}else{for(e=0;e<this.$items.length;e++)d(this.$items[e]).detach();if(this.cols)for(e=0;e<this.cols.length;e++)this.cols[e].remove();this.cols=[];this.colWidth=this.settings.percentageWidths?Math.floor(100/
this.totalCols)+"%":this.settings.minColWidth+"px";a=Math.min(this.totalCols,this.$items.length);for(e=0;e<a;e++)this.cols[e]=new Craft.Grid.Col(this,e);if(1==this.cols.length)for(e=0;e<this.$items.length;e++)this.cols[0].append(this.$items[e]),this.settings.snapToGrid&&(a=d(this.$items[e]).height("auto").height(),(c=a%this.settings.snapToGrid)&&d(this.$items[e]).height(a+this.settings.snapToGrid-c));else switch(this.settings.fillMode){case "top":for(e=0;e<this.$items.length;e++)this.getShortestCol().append(this.$items[e]);
break;case "ltr":this.itemHeights=[];this.ltrScenarios=[];for(e=this.totalItemHeight=0;e<this.$items.length;e++)this.cols[0].append(this.$items[e]),this.itemHeights[e]=d(this.$items[e]).height(),this.totalItemHeight+=this.itemHeights[e],d(this.$items[e]).detach();this.avgColHeight=this.totalItemHeight/this.cols.length;this.ltrScenarios.push(new Craft.Grid.LtrScenario(this,0,0,[[]],0));a=this.ltrScenarios[0];for(e=1;e<this.ltrScenarios.length;e++)this.ltrScenarios[e].tallestColHeight<a.tallestColHeight&&
(a=this.ltrScenarios[e]);for(e=0;e<a.placements.length;e++)for(b=0;b<a.placements[e].length;b++)this.cols[e].append(this.$items[a.placements[e][b]])}}},getShortestCol:function(){for(var a,b,c=0;c<this.cols.length;c++){var d=this.cols[c],f=this.cols[c].height();if("undefined"==typeof a||f<b)a=d,b=f}return a},getTallestCol:function(){for(var a,b,c=0;c<this.cols.length;c++){var d=this.cols[c],f=this.cols[c].height();if("undefined"==typeof a||f>b)a=d,b=f}return a}},{defaults:{itemSelector:":visible",
minColWidth:325,percentageWidths:!0,fillMode:"grid",snapToGrid:null}});Craft.Grid.Col=Garnish.Base.extend({grid:null,index:null,$outerContainer:null,$innerContainer:null,init:function(a,b){this.grid=a;this.index=b;this.$outerContainer=d('<div class="col" style="width: '+this.grid.colWidth+'"/>').appendTo(this.grid.$container);this.$innerContainer=d('<div class="col-inner">').appendTo(this.$outerContainer)},height:function(a){if("undefined"!=typeof a)this.$innerContainer.height(a);else return this.$innerContainer.height("auto"),
this.$outerContainer.height()},append:function(a){this.$innerContainer.append(a)},remove:function(){this.$outerContainer.remove()}});Craft.Grid.LtrScenario=Garnish.Base.extend({placements:null,tallestColHeight:null,init:function(a,b,c,e,f){this.placements=e;this.tallestColHeight=f;f=0;for(b;b<a.$items.length;b++)e=f+a.itemHeights[b],e<=a.avgColHeight||c==a.cols.length-1?(this.placements[c].push(b),f+=a.itemHeights[b],this.checkColHeight(e)):(this.placements[c+1]=[],f=d.extend(!0,[],this.placements),
f[c].push(b),e=Math.max(this.tallestColHeight,e),a.ltrScenarios.push(new Craft.Grid.LtrScenario(a,b+1,c+1,f,e)),c++,this.placements[c].push(b),this.checkColHeight(a.itemHeights[b]),f=a.itemHeights[b])},checkColHeight:function(a){a>this.tallestColHeight&&(this.tallestColHeight=a)}});Craft.HandleGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(a){a=a.replace("/<(.*?)>/g","");a=a.toLowerCase();a=Craft.asciiString(a);a=a.replace(/^[^a-z]+/,"");var b=Craft.filterArray(a.split(/[^a-z0-9]+/));
a="";for(var c=0;c<b.length;c++)a=0==c?a+b[c]:a+(b[c].charAt(0).toUpperCase()+b[c].substr(1));return a}});Craft.ImageUpload=Garnish.Base.extend({_imageHandler:null,init:function(a){this.setSettings(a,Craft.ImageUpload.defaults);this._imageHandler=new Craft.ImageHandler(a)}},{$modalContainerDiv:null,defaults:{postParameters:{},modalClass:"",uploadButton:{},uploadAction:"",deleteButton:{},deleteMessage:"",deleteAction:"",cropAction:"",areaToolOptions:{aspectRatio:"1:1",initialRectangle:{mode:"auto",
x1:0,x2:0,y1:0,y2:0}},onImageDelete:function(a){location.reload()},onImageSave:function(a){location.reload()}}});Craft.ImageHandler=Garnish.Base.extend({modal:null,init:function(a){this.setSettings(a);var b=this,c={element:this.settings.uploadButton[0],action:Craft.actionUrl+"/"+this.settings.uploadAction,params:this.settings.postParameters,multiple:!1,onComplete:function(c,f,g){null==Craft.ImageUpload.$modalContainerDiv&&(Craft.ImageUpload.$modalContainerDiv=d('<div class="modal"></div>').addClass(a.modalClass).appendTo(Garnish.$bod));
g.html&&(Craft.ImageUpload.$modalContainerDiv.empty().append(g.html),this.modal?this.modal.show():(this.modal=new Craft.ImageModal(Craft.ImageUpload.$modalContainerDiv,{postParameters:a.postParameters,cropAction:a.cropAction}),this.modal.imageHandler=b),this.modal.bindButtons(),this.modal.addListener(this.modal.$saveBtn,"click","saveImage"),this.modal.addListener(this.modal.$cancelBtn,"click","cancel"),this.modal.removeListener(Garnish.Modal.$shade,"click"),setTimeout(d.proxy(function(){Craft.ImageUpload.$modalContainerDiv.find("img").load(d.proxy(function(){(new Craft.ImageAreaTool(a.areaToolOptions)).showArea(this.modal)},
this))},this),1))},allowedExtensions:["jpg","jpeg","gif","png"],template:'<div class="QqUploader-uploader"><div class="QqUploader-upload-drop-area" style="display: none; "><span></span></div><div class="QqUploader-upload-button" style="position: relative; overflow: hidden; direction: ltr; ">'+a.uploadButton.text()+'<input type="file" name="file" style="position: absolute; right: 0px; top: 0px; font-family: Arial; font-size: 118px; margin: 0px; padding: 0px; cursor: pointer; opacity: 0; "></div><ul class="QqUploader-upload-list"></ul></div>'};
c.sizeLimit=Craft.maxUploadSize;this.uploader=new qqUploader.FileUploader(c);d(a.deleteButton).click(function(){confirm(a.deleteMessage)&&(d(this).parent().append('<div class="blocking-modal"></div>'),Craft.postActionRequest(a.deleteAction,a.postParameters,d.proxy(function(a,c){"success"==c&&b.onImageDelete.apply(b,[a])},this)))})},onImageSave:function(a){this.settings.onImageSave.apply(this,[a])},onImageDelete:function(a){this.settings.onImageDelete.apply(this,[a])}});Craft.ImageModal=Garnish.Modal.extend({$container:null,
$saveBtn:null,$cancelBtn:null,areaSelect:null,factor:null,source:null,_postParameters:null,_cropAction:"",imageHandler:null,init:function(a,b){this.base(a,b);this._postParameters=b.postParameters;this._cropAction=b.cropAction},bindButtons:function(){this.$saveBtn=this.$container.find(".submit:first");this.$cancelBtn=this.$container.find(".cancel:first")},cancel:function(){this.hide();this.areaSelect.setOptions({remove:!0,hide:!0,disable:!0});this.$container.empty()},saveImage:function(){var a=this.areaSelect.getSelection(),
a={x1:Math.round(a.x1/this.factor),x2:Math.round(a.x2/this.factor),y1:Math.round(a.y1/this.factor),y2:Math.round(a.y2/this.factor),source:this.source},a=d.extend(this._postParameters,a);Craft.postActionRequest(this._cropAction,a,d.proxy(function(a,c){"success"==c&&(a.error?Craft.cp.displayError(a.error):this.imageHandler.onImageSave.apply(this.imageHandler,[a]));this.hide();this.$container.empty();this.areaSelect.setOptions({remove:!0,hide:!0,disable:!0})},this));this.areaSelect.setOptions({disable:!0});
this.removeListener(this.$saveBtn,"click");this.removeListener(this.$cancelBtn,"click");this.$container.find(".crop-image").fadeTo(50,0.5)}});Craft.ImageAreaTool=Garnish.Base.extend({$container:null,init:function(a){this.$container=Craft.ImageUpload.$modalContainerDiv;this.setSettings(a)},showArea:function(a){var b=this.$container.find("img"),c={aspectRatio:this.settings.aspectRatio,maxWidth:b.width(),maxHeight:b.height(),instance:!0,resizable:!0,show:!0,persistent:!0,handles:!0,parent:b.parent()},
c=b.imgAreaSelect(c),d=this.settings.initialRectangle.x1,f=this.settings.initialRectangle.x2,g=this.settings.initialRectangle.y1,h=this.settings.initialRectangle.y2;"auto"==this.settings.initialRectangle.mode&&(d=this.settings.aspectRatio.split(":"),h=f=0,d[0]>d[1]?(f=b.width(),h=f*d[1]/d[0]):d[0]>d[1]?(h=b.height(),f=h*d[0]/d[1]):h=f=Math.min(b.width(),b.height()),d=Math.round((b.width()-f)/2),g=Math.round((b.height()-h)/2),f=d+f,h=g+h);c.setSelection(d,g,f,h);c.update();a.areaSelect=c;a.factor=
b.attr("data-factor");a.source=b.attr("src").split("/").pop()}});Craft.LightSwitch=Garnish.Base.extend({settings:null,$outerContainer:null,$innerContainer:null,$input:null,$toggleTarget:null,on:null,dragger:null,dragStartMargin:null,init:function(a,b){this.$outerContainer=d(a);this.$outerContainer.data("lightswitch")&&(Garnish.log("Double-instantiating a switch on an element"),this.$outerContainer.data("lightswitch").destroy());this.$outerContainer.data("lightswitch",this);this.setSettings(b,Craft.LightSwitch.defaults);
this.$innerContainer=this.$outerContainer.find(".container:first");this.$input=this.$outerContainer.find("input:first");this.$toggleTarget=d(this.$outerContainer.attr("data-toggle"));this.on=this.$outerContainer.hasClass("on");this.addListener(this.$outerContainer,"mousedown","_onMouseDown");this.addListener(this.$outerContainer,"keydown","_onKeyDown");this.dragger=new Garnish.BaseDrag(this.$outerContainer,{axis:Garnish.X_AXIS,ignoreButtons:!1,onDragStart:d.proxy(this,"_onDragStart"),onDrag:d.proxy(this,
"_onDrag"),onDragStop:d.proxy(this,"_onDragStop")})},turnOn:function(){this.$innerContainer.stop().animate({marginLeft:0},"fast");this.$input.val("on");this.$outerContainer.addClass("on");this.on=!0;this.settings.onChange();this.$toggleTarget.show();this.$toggleTarget.height("auto");var a=this.$toggleTarget.height();this.$toggleTarget.height(0);this.$toggleTarget.stop().animate({height:a},"fast",d.proxy(function(){this.$toggleTarget.height("auto")},this))},turnOff:function(){this.$innerContainer.stop().animate({marginLeft:Craft.LightSwitch.offMargin},
"fast");this.$input.val("");this.$outerContainer.removeClass("on");this.on=!1;this.settings.onChange();this.$toggleTarget.stop().animate({height:0},"fast")},toggle:function(a){this.on?this.turnOff():this.turnOn()},_onMouseDown:function(){this.addListener(Garnish.$doc,"mouseup","_onMouseUp")},_onMouseUp:function(){this.removeListener(Garnish.$doc,"mouseup");this.dragger.dragging||this.toggle()},_onKeyDown:function(a){switch(a.keyCode){case Garnish.SPACE_KEY:this.toggle();a.preventDefault();break;case Garnish.RIGHT_KEY:this.turnOn();
a.preventDefault();break;case Garnish.LEFT_KEY:this.turnOff(),a.preventDefault()}},_getMargin:function(){return parseInt(this.$innerContainer.css("marginLeft"))},_onDragStart:function(){this.dragStartMargin=this._getMargin()},_onDrag:function(){var a=this.dragStartMargin+this.dragger.mouseDistX;a<Craft.LightSwitch.offMargin?a=Craft.LightSwitch.offMargin:0<a&&(a=0);this.$innerContainer.css("marginLeft",a)},_onDragStop:function(){-16<this._getMargin()?this.turnOn():this.turnOff()},destroy:function(){this.base();
this.dragger.destroy()}},{offMargin:-50,defaults:{onChange:function(){}}});Craft.PasswordInput=Garnish.Base.extend({$passwordInput:null,$textInput:null,$currentInput:null,$showPasswordToggle:null,showingPassword:null,init:function(a,b){this.$passwordInput=d(a);this.settings=d.extend({},Craft.PasswordInput.defaults,b);this.$passwordInput.data("passwordInput")&&(Garnish.log("Double-instantiating a password input on an element"),this.$passwordInput.data("passwordInput").destroy());this.$passwordInput.data("passwordInput",
this);this.$showPasswordToggle=d("<a/>").hide();this.$showPasswordToggle.addClass("password-toggle");this.$showPasswordToggle.insertAfter(this.$passwordInput);this.addListener(this.$showPasswordToggle,"mousedown","onToggleMouseDown");this.hidePassword()},setCurrentInput:function(a){this.$currentInput&&(a.addClass("focus"),this.$currentInput.replaceWith(a),a.focus(),a.removeClass("focus"),a.val(this.$currentInput.val()));this.$currentInput=a;this.addListener(this.$currentInput,"keypress,keyup,change,blur",
"onInputChange")},updateToggleLabel:function(a){this.$showPasswordToggle.text(a)},showPassword:function(){this.showingPassword||(this.$textInput||(this.$textInput=this.$passwordInput.clone(!0),this.$textInput.attr("type","text")),this.setCurrentInput(this.$textInput),this.updateToggleLabel(Craft.t("Hide")),this.showingPassword=!0)},hidePassword:function(){!1!==this.showingPassword&&(this.setCurrentInput(this.$passwordInput),this.updateToggleLabel(Craft.t("Show")),this.showingPassword=!1,this.addListener(this.$passwordInput,
"keydown","onKeyDown"))},togglePassword:function(){this.showingPassword?this.hidePassword():this.showPassword();this.settings.onToggleInput(this.$currentInput)},onKeyDown:function(a){a.keyCode==Garnish.ALT_KEY&&this.$currentInput.val()&&(this.showPassword(),this.$showPasswordToggle.hide(),this.addListener(this.$textInput,"keyup","onKeyUp"))},onKeyUp:function(a){a.preventDefault();a.keyCode==Garnish.ALT_KEY&&(this.hidePassword(),this.$showPasswordToggle.show())},onInputChange:function(){this.$currentInput.val()?
this.$showPasswordToggle.show():this.$showPasswordToggle.hide()},onToggleMouseDown:function(a){a.preventDefault();if(this.$currentInput[0].setSelectionRange)var b=this.$currentInput[0].selectionStart,c=this.$currentInput[0].selectionEnd;this.togglePassword();this.$currentInput[0].setSelectionRange&&this.$currentInput[0].setSelectionRange(b,c)}},{defaults:{onToggleInput:d.noop}});Craft.ProgressBar=Garnish.Base.extend({$uploadProgress:null,$uploadProgressBar:null,_itemCount:0,_processedItemCount:0,
init:function(a){this.$uploadProgress=a;this.$uploadProgressBar=d(".assets-pb-bar",this.$uploadProgress);this.resetProgressBar()},resetProgressBar:function(){this.setItemCount(1);this.setProcessedItemCount(0);this.updateProgressBar()},hideProgressBar:function(){this.$uploadProgress.fadeTo("fast",0.01,d.proxy(function(){this.$uploadProgress.addClass("hidden").fadeTo(1,1,function(){})},this))},showProgressBar:function(){this.$uploadProgress.removeClass("hidden")},setItemCount:function(a){this._itemCount=
a},incrementItemCount:function(a){this._itemCount+=a},setProcessedItemCount:function(a){this._processedItemCount=a},incrementProcessedItemCount:function(a){this._processedItemCount+=a},updateProgressBar:function(){this._itemCount=Math.max(this._itemCount,1);var a=Math.min(100,Math.round(100*this._processedItemCount/this._itemCount));this.setProgressPercentage(a)},setProgressPercentage:function(a){this.$uploadProgressBar.width(a+"%")}});Craft.PromptHandler=Garnish.Base.extend({$modalContainerDiv:null,
$prompt:null,$promptApplyToRemainingContainer:null,$promptApplyToRemainingCheckbox:null,$promptApplyToRemainingLabel:null,$promptButtons:null,_prompts:[],_promptBatchCallback:d.noop,_promptBatchReturnData:[],_promptBatchNum:0,init:function(){},resetPrompts:function(){this._prompts=[];this._promptBatchCallback=d.noop;this._promptBatchReturnData=[];this._promptBatchNum=0},addPrompt:function(a){this._prompts.push(a)},getPromptCount:function(){return this._prompts.length},showBatchPrompts:function(a){this._promptBatchCallback=
a;this._promptBatchReturnData=[];this._promptBatchNum=0;this._showNextPromptInBatch()},_showNextPromptInBatch:function(){var a=this._prompts[this._promptBatchNum].prompt,b=this._prompts.length-(this._promptBatchNum+1);this._showPrompt(a.message,a.choices,d.proxy(this,"_handleBatchPromptSelection"),b)},_handleBatchPromptSelection:function(a,b){var c=this._prompts.length-(this._promptBatchNum+1),e=d.extend(this._prompts[this._promptBatchNum],{choice:a});this._promptBatchReturnData.push(e);c?(this._promptBatchNum++,
b?this._handleBatchPromptSelection(a,!0):this._showNextPromptInBatch()):"function"==typeof this._promptBatchCallback&&this._promptBatchCallback(this._promptBatchReturnData)},_showPrompt:function(a,b,c,e){this._promptCallback=c;null==this.modal&&(this.modal=new Garnish.Modal({closeOtherModals:!1}));null==this.$modalContainerDiv&&(this.$modalContainerDiv=d('<div class="modal prompt-modal"></div>').addClass().appendTo(Garnish.$bod));this.$prompt=d('<div class="body"></div>').appendTo(this.$modalContainerDiv.empty());
this.$promptMessage=d('<p class="prompt-msg"/>').appendTo(this.$prompt);d("<p>").html(Craft.t("What do you want to do?")).appendTo(this.$prompt);this.$promptApplyToRemainingContainer=d('<label class="assets-applytoremaining"/>').appendTo(this.$prompt).hide();this.$promptApplyToRemainingCheckbox=d('<input type="checkbox"/>').appendTo(this.$promptApplyToRemainingContainer);this.$promptApplyToRemainingLabel=d("<span/>").appendTo(this.$promptApplyToRemainingContainer);this.$promptButtons=d('<div class="buttons"/>').appendTo(this.$prompt);
this.modal.setContainer(this.$modalContainerDiv);this.$promptMessage.html(a);for(a=0;a<b.length;a++)c=d('<div class="btn" data-choice="'+b[a].value+'">'+b[a].title+"</div>"),this.addListener(c,"activate",function(a){a=a.currentTarget.getAttribute("data-choice");var b=this.$promptApplyToRemainingCheckbox.prop("checked");this._selectPromptChoice(a,b)}),this.$promptButtons.append(c).append("<br />");e&&(this.$promptApplyToRemainingContainer.show(),this.$promptApplyToRemainingLabel.html(" "+Craft.t("Apply this to the {number} remaining conflicts?",
{number:e})));this.modal.show();this.modal.removeListener(Garnish.Modal.$shade,"click");this.addListener(Garnish.Modal.$shade,"click","_cancelPrompt")},_selectPromptChoice:function(a,b){this.$prompt.fadeOut("fast",d.proxy(function(){this.modal.hide();this._promptCallback(a,b)},this))},_cancelPrompt:function(){this._selectPromptChoice("cancel",!0)}});(function(){var a=a||{};a.extend=function(a,c){for(var d in c)a[d]=c[d]};a.indexOf=function(a,c,d){if(a.indexOf)return a.indexOf(c,d);d=d||0;var f=a.length;
for(0>d&&(d+=f);d<f;d++)if(d in a&&a[d]===c)return d;return-1};a.getUniqueId=function(){var a=0;return function(){return a++}}();a.attach=function(a,c,d){a.addEventListener?a.addEventListener(c,d,!1):a.attachEvent&&a.attachEvent("on"+c,d)};a.detach=function(a,c,d){a.removeEventListener?a.removeEventListener(c,d,!1):a.attachEvent&&a.detachEvent("on"+c,d)};a.preventDefault=function(a){a.preventDefault?a.preventDefault():a.returnValue=!1};a.insertBefore=function(a,c){c.parentNode.insertBefore(a,c)};
a.remove=function(a){a.parentNode.removeChild(a)};a.contains=function(a,c){return a==c?!0:a.contains?a.contains(c):!!(c.compareDocumentPosition(a)&8)};a.toElement=function(){var a=document.createElement("div");return function(c){a.innerHTML=c;c=a.firstChild;a.removeChild(c);return c}}();a.css=function(b,c){null!=c.opacity&&"string"!=typeof b.style.opacity&&"undefined"!=typeof b.filters&&(c.filter="alpha(opacity="+Math.round(100*c.opacity)+")");a.extend(b.style,c)};a.hasClass=function(a,c){return RegExp("(^| )"+
c+"( |$)").test(a.className)};a.addClass=function(b,c){a.hasClass(b,c)||(b.className+=" "+c)};a.removeClass=function(a,c){a.className=a.className.replace(RegExp("(^| )"+c+"( |$)")," ").replace(/^\s+|\s+$/g,"")};a.setText=function(a,c){a.innerText=c;a.textContent=c};a.children=function(a){var c=[];for(a=a.firstChild;a;)1==a.nodeType&&c.push(a),a=a.nextSibling;return c};a.getByClass=function(b,c){if(b.querySelectorAll)return b.querySelectorAll("."+c);for(var d=[],f=b.getElementsByTagName("*"),g=f.length,
h=0;h<g;h++)a.hasClass(f[h],c)&&d.push(f[h]);return d};a.obj2url=function(b,c,d){var f=[],g="&",h=function(b,d){var e=c?/\[\]$/.test(c)?c:c+"["+d+"]":d;"undefined"!=e&&"undefined"!=d&&f.push("object"===typeof b?a.obj2url(b,e,!0):"[object Function]"===Object.prototype.toString.call(b)?encodeURIComponent(e)+"="+encodeURIComponent(b()):encodeURIComponent(e)+"="+encodeURIComponent(b))};if(!d&&c)g=/\?/.test(c)?/\?$/.test(c)?"":"&":"?",f.push(c),f.push(a.obj2url(b));else if("[object Array]"===Object.prototype.toString.call(b)&&
"undefined"!=typeof b){var k=0;for(d=b.length;k<d;++k)h(b[k],k)}else if("undefined"!=typeof b&&null!==b&&"object"===typeof b)for(k in b)h(b[k],k);else f.push(encodeURIComponent(c)+"="+encodeURIComponent(b));return f.join(g).replace(/^&/,"").replace(/%20/g,"+")};a=a||{};a.FileUploaderBasic=function(b){this._options={debug:!1,action:"/server/upload",params:{},button:null,multiple:!0,maxConnections:3,allowedExtensions:[],sizeLimit:0,minSizeLimit:0,onSubmit:function(a,b){},onProgress:function(a,b,d,g){},
onComplete:function(a,b,d){},onCancel:function(a,b){},messages:{typeError:"{file} has invalid extension. Only {extensions} are allowed.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",minSizeError:"{file} is too small, minimum file size is {minSizeLimit}.",emptyError:"{file} is empty, please select files again without it.",onLeave:"The files are being uploaded, if you leave now the upload will be cancelled."},showMessage:function(a){alert(a)}};a.extend(this._options,b);this._filesInProgress=
0;this._handler=this._createUploadHandler();this._options.button&&(this._button=this._createUploadButton(this._options.button));this._preventLeaveInProgress()};a.FileUploaderBasic.prototype={setParams:function(a){this._options.params=a},getInProgress:function(){return this._filesInProgress},_createUploadButton:function(b){var c=this;return new a.UploadButton({element:b,multiple:this._options.multiple&&a.UploadHandlerXhr.isSupported(),onChange:function(a){c._onInputChange(a)}})},_createUploadHandler:function(){var b=
this,c;c=a.UploadHandlerXhr.isSupported()?"UploadHandlerXhr":"UploadHandlerForm";return new a[c]({debug:this._options.debug,action:this._options.action,maxConnections:this._options.maxConnections,onProgress:function(a,c,d,h){b._onProgress(a,c,d,h);b._options.onProgress(a,c,d,h)},onComplete:function(a,c,d){b._onComplete(a,c,d);b._options.onComplete(a,c,d)},onCancel:function(a,c){b._onCancel(a,c);b._options.onCancel(a,c)}})},_preventLeaveInProgress:function(){var b=this;a.attach(window,"beforeunload",
function(a){if(b._filesInProgress)return a=a||window.event,a.returnValue=b._options.messages.onLeave})},_onSubmit:function(a,c){this._filesInProgress++},_onProgress:function(a,c,d,f){},_onComplete:function(a,c,d){this._filesInProgress--;d.error&&this._options.showMessage(d.error)},_onCancel:function(a,c){this._filesInProgress--},_onInputChange:function(b){this._handler instanceof a.UploadHandlerXhr?this._uploadFileList(b.files):this._validateFile(b)&&this._uploadFile(b);this._button.reset()},_uploadFileList:function(a){for(var c=
0;c<a.length;c++)if(!this._validateFile(a[c]))return;for(c=0;c<a.length;c++)this._uploadFile(a[c])},_uploadFile:function(a){a=this._handler.add(a);var c=this._handler.getName(a);!1!==this._options.onSubmit(a,c)&&(this._onSubmit(a,c),this._handler.upload(a,this._options.params))},_validateFile:function(a){var c,d;a.value?c=a.value.replace(/.*(\/|\\)/,""):(c=null!=a.fileName?a.fileName:a.name,d=null!=a.fileSize?a.fileSize:a.size);if(this._isAllowedExtension(c)){if(0===d)return this._error("emptyError",
c),!1;if(d&&this._options.sizeLimit&&d>this._options.sizeLimit)return this._error("sizeError",c),!1;if(d&&d<this._options.minSizeLimit)return this._error("minSizeError",c),!1}else return this._error("typeError",c),!1;return!0},_error:function(a,c){var d=this._options.messages[a],f=this._formatFileName(c),d=d.replace("{file}",f),f=this._options.allowedExtensions.join(", "),d=d.replace("{extensions}",f),f=this._formatSize(this._options.sizeLimit),d=d.replace("{sizeLimit}",f),f=this._formatSize(this._options.minSizeLimit),
d=d.replace("{minSizeLimit}",f);this._options.showMessage(d)},_formatFileName:function(a){33<a.length&&(a=a.slice(0,19)+"..."+a.slice(-13));return a},_isAllowedExtension:function(a){a=-1!==a.indexOf(".")?a.replace(/.*[.]/,"").toLowerCase():"";var c=this._options.allowedExtensions;if(!c.length)return!0;for(var d=0;d<c.length;d++)if(c[d].toLowerCase()==a)return!0;return!1},_formatSize:function(a){var c=-1;do a/=1024,c++;while(99<a);return Math.max(a,0.1).toFixed(1)+"kB MB GB TB PB EB".split(" ")[c]}};
a.FileUploader=function(b){a.FileUploaderBasic.apply(this,arguments);a.extend(this._options,{element:null,listElement:null,template:'<div class="QqUploader-uploader"><div class="QqUploader-upload-drop-area"><span>Drop files here to upload</span></div><div class="QqUploader-upload-button">Upload a file</div><ul class="QqUploader-upload-list"></ul></div>',fileTemplate:'<li><span class="QqUploader-upload-file"></span><span class="QqUploader-upload-spinner"></span><span class="QqUploader-upload-size"></span><a class="QqUploader-upload-cancel" href="#">Cancel</a><span class="QqUploader-upload-failed-text">Failed</span></li>',
classes:{button:"QqUploader-upload-button",drop:"QqUploader-upload-drop-area",dropActive:"QqUploader-upload-drop-area-active",list:"QqUploader-upload-list",file:"QqUploader-upload-file",spinner:"QqUploader-upload-spinner",size:"QqUploader-upload-size",cancel:"QqUploader-upload-cancel",success:"QqUploader-upload-success",fail:"QqUploader-upload-fail"}});a.extend(this._options,b);this._element=this._options.element;this._element.innerHTML=this._options.template;this._listElement=this._options.listElement||
this._find(this._element,"list");this._classes=this._options.classes;this._button=this._createUploadButton(this._find(this._element,"button"));this._bindCancelEvent();this._setupDragDrop()};a.extend(a.FileUploader.prototype,a.FileUploaderBasic.prototype);a.extend(a.FileUploader.prototype,{_find:function(b,c){var d=a.getByClass(b,this._options.classes[c])[0];if(!d)throw Error("element not found: "+c);return d},_setupDragDrop:function(){var b=this,c=this._find(this._element,"drop"),d=new a.UploadDropZone({element:c,
onEnter:function(d){a.addClass(c,b._classes.dropActive);d.stopPropagation()},onLeave:function(a){a.stopPropagation()},onLeaveNotDescendants:function(d){a.removeClass(c,b._classes.dropActive)},onDrop:function(d){c.style.display="none";a.removeClass(c,b._classes.dropActive);b._uploadFileList(d.dataTransfer.files)}});c.style.display="none";a.attach(document,"dragenter",function(a){d._isValidFileDrag(a)&&(c.style.display="block")});a.attach(document,"dragleave",function(a){d._isValidFileDrag(a)&&(a=document.elementFromPoint(a.clientX,
a.clientY),a&&"HTML"!=a.nodeName||(c.style.display="none"))})},_onSubmit:function(b,c){a.FileUploaderBasic.prototype._onSubmit.apply(this,arguments);this._addToList(b,c)},_onProgress:function(b,c,d,f){a.FileUploaderBasic.prototype._onProgress.apply(this,arguments);var g=this._getItemByFileId(b),g=this._find(g,"size");g.style.display="inline";var h;h=d!=f?Math.round(100*(d/f))+"% from "+this._formatSize(f):this._formatSize(f);a.setText(g,h)},_onComplete:function(b,c,d){a.FileUploaderBasic.prototype._onComplete.apply(this,
arguments);var f=this._getItemByFileId(b);a.remove(this._find(f,"cancel"));a.remove(this._find(f,"spinner"));d.success?a.addClass(f,this._classes.success):a.addClass(f,this._classes.fail)},_addToList:function(b,c){var d=a.toElement(this._options.fileTemplate);d.qqfileId=b;var f=this._find(d,"file");a.setText(f,this._formatFileName(c));this._find(d,"size").style.display="none";this._listElement.appendChild(d)},_getItemByFileId:function(a){for(var c=this._listElement.firstChild;c;){if(c.qqfileId==a)return c;
c=c.nextSibling}},_bindCancelEvent:function(){var b=this;a.attach(this._listElement,"click",function(c){c=c||window.event;var d=c.target||c.srcElement;a.hasClass(d,b._classes.cancel)&&(a.preventDefault(c),c=d.parentNode,b._handler.cancel(c.qqfileId),a.remove(c))})}});a.UploadDropZone=function(b){this._options={element:null,onEnter:function(a){},onLeave:function(a){},onLeaveNotDescendants:function(a){},onDrop:function(a){}};a.extend(this._options,b);this._element=this._options.element;this._disableDropOutside();
this._attachEvents()};a.UploadDropZone.prototype={_disableDropOutside:function(b){a.UploadDropZone.dropOutsideDisabled||(a.attach(document,"dragover",function(a){a.dataTransfer&&(a.dataTransfer.dropEffect="none",a.preventDefault())}),a.UploadDropZone.dropOutsideDisabled=!0)},_attachEvents:function(){var b=this;a.attach(b._element,"dragover",function(a){if(b._isValidFileDrag(a)){var d=a.dataTransfer.effectAllowed;a.dataTransfer.dropEffect="move"==d||"linkMove"==d?"move":"copy";a.stopPropagation();
a.preventDefault()}});a.attach(b._element,"dragenter",function(a){if(b._isValidFileDrag(a))b._options.onEnter(a)});a.attach(b._element,"dragleave",function(c){if(b._isValidFileDrag(c)){b._options.onLeave(c);var d=document.elementFromPoint(c.clientX,c.clientY);if(!a.contains(this,d))b._options.onLeaveNotDescendants(c)}});a.attach(b._element,"drop",function(a){b._isValidFileDrag(a)&&(a.preventDefault(),b._options.onDrop(a))})},_isValidFileDrag:function(a){a=a.dataTransfer;var c=-1<navigator.userAgent.indexOf("AppleWebKit");
return a&&"none"!=a.effectAllowed&&(a.files||!c&&a.types.contains&&a.types.contains("Files"))}};a.UploadButton=function(b){this._options={element:null,multiple:!1,name:"file",onChange:function(a){},hoverClass:"QqUploader-upload-button-hover",focusClass:"QqUploader-upload-button-focus"};a.extend(this._options,b);this._element=this._options.element;a.css(this._element,{position:"relative",overflow:"hidden",direction:"ltr"});this._input=this._createInput()};a.UploadButton.prototype={getInput:function(){return this._input},
reset:function(){this._input.parentNode&&a.remove(this._input);a.removeClass(this._element,this._options.focusClass);this._input=this._createInput()},_createInput:function(){var b=document.createElement("input");this._options.multiple&&b.setAttribute("multiple","multiple");b.setAttribute("type","file");b.setAttribute("name",this._options.name);a.css(b,{position:"absolute",right:0,top:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,cursor:"pointer",opacity:0});this._element.appendChild(b);
var c=this;a.attach(b,"change",function(){c._options.onChange(b)});a.attach(b,"mouseover",function(){a.addClass(c._element,c._options.hoverClass)});a.attach(b,"mouseout",function(){a.removeClass(c._element,c._options.hoverClass)});a.attach(b,"focus",function(){a.addClass(c._element,c._options.focusClass)});a.attach(b,"blur",function(){a.removeClass(c._element,c._options.focusClass)});window.attachEvent&&b.setAttribute("tabIndex","-1");return b}};a.UploadHandlerAbstract=function(b){this._options={debug:!1,
action:"/upload.php",maxConnections:999,onProgress:function(a,b,d,g){},onComplete:function(a,b,d){},onCancel:function(a,b){}};a.extend(this._options,b);this._queue=[];this._params=[]};a.UploadHandlerAbstract.prototype={log:function(a){this._options.debug&&window.console&&console.log("[uploader] "+a)},add:function(a){},upload:function(b,c){var d=this._queue.push(b),f={};a.extend(f,c);this._params[b]=f;d<=this._options.maxConnections&&this._upload(b,this._params[b])},cancel:function(a){this._cancel(a);
this._dequeue(a)},cancelAll:function(){for(var a=0;a<this._queue.length;a++)this._cancel(this._queue[a]);this._queue=[]},getName:function(a){},getSize:function(a){},getQueue:function(){return this._queue},_upload:function(a){},_cancel:function(a){},_dequeue:function(b){b=a.indexOf(this._queue,b);this._queue.splice(b,1);var c=this._options.maxConnections;this._queue.length>=c&&b<c&&(b=this._queue[c-1],this._upload(b,this._params[b]))}};a.UploadHandlerForm=function(b){a.UploadHandlerAbstract.apply(this,
arguments);this._inputs={}};a.extend(a.UploadHandlerForm.prototype,a.UploadHandlerAbstract.prototype);a.extend(a.UploadHandlerForm.prototype,{add:function(b){b.setAttribute("name","qqfile");var c="QqUploader-upload-handler-iframe"+a.getUniqueId();this._inputs[c]=b;b.parentNode&&a.remove(b);return c},getName:function(a){return this._inputs[a].value.replace(/.*(\/|\\)/,"")},_cancel:function(b){this._options.onCancel(b,this.getName(b));delete this._inputs[b];if(b=document.getElementById(b))b.setAttribute("src",
"javascript:false;"),a.remove(b)},_upload:function(b,c){var d=this._inputs[b];if(!d)throw Error("file with passed id was not added, or already uploaded or cancelled");var f=this.getName(b),g=this._createIframe(b),h=this._createForm(g,c);h.appendChild(d);var k=this;this._attachLoadEvent(g,function(){k.log("iframe loaded");var c=k._getIframeContentJSON(g);k._options.onComplete(b,f,c);k._dequeue(b);delete k._inputs[b];setTimeout(function(){a.remove(g)},1)});h.submit();a.remove(h);return b},_attachLoadEvent:function(b,
c){a.attach(b,"load",function(){b.parentNode&&(b.contentDocument&&b.contentDocument.body&&"false"==b.contentDocument.body.innerHTML||c())})},_getIframeContentJSON:function(a){a=a.contentDocument?a.contentDocument:a.contentWindow.document;var c;this.log("converting iframe's innerHTML to JSON");this.log("innerHTML = "+a.body.innerHTML);try{c=eval("("+a.body.innerHTML+")")}catch(d){c={}}return c},_createIframe:function(b){var c=a.toElement('<iframe src="javascript:false;" name="'+b+'" />');c.setAttribute("id",
b);c.style.display="none";document.body.appendChild(c);return c},_createForm:function(b,c){var d=a.toElement('<form method="post" enctype="multipart/form-data"></form>'),f=a.obj2url(c,this._options.action);d.setAttribute("action",f);d.setAttribute("target",b.name);d.style.display="none";document.body.appendChild(d);return d}});a.UploadHandlerXhr=function(b){a.UploadHandlerAbstract.apply(this,arguments);this._files=[];this._xhrs=[];this._loaded=[]};a.UploadHandlerXhr.isSupported=function(){var a=document.createElement("input");
a.type="file";return"multiple"in a&&"undefined"!=typeof File&&"undefined"!=typeof(new XMLHttpRequest).upload};a.extend(a.UploadHandlerXhr.prototype,a.UploadHandlerAbstract.prototype);a.extend(a.UploadHandlerXhr.prototype,{add:function(a){if(!(a instanceof File))throw Error("Passed obj in not a File (in QqUploader.UploadHandlerXhr)");return this._files.push(a)-1},getName:function(a){a=this._files[a];return null!=a.fileName?a.fileName:a.name},getSize:function(a){a=this._files[a];return null!=a.fileSize?
a.fileSize:a.size},getLoaded:function(a){return this._loaded[a]||0},_upload:function(b,c){var d=this._files[b],f=this.getName(b);this.getSize(b);this._loaded[b]=0;var g=this._xhrs[b]=new XMLHttpRequest,h=this;g.upload.onprogress=function(a){a.lengthComputable&&(h._loaded[b]=a.loaded,h._options.onProgress(b,f,a.loaded,a.total))};g.onreadystatechange=function(){4==g.readyState&&h._onComplete(b,g)};c=c||{};c.qqfile=f;var k=a.obj2url(c,this._options.action);g.open("POST",k,!0);g.setRequestHeader("X-Requested-With",
"XMLHttpRequest");g.setRequestHeader("X-File-Name",encodeURIComponent(f));g.setRequestHeader("Content-Type","application/octet-stream");g.send(d)},_onComplete:function(a,c){if(this._files[a]){var d=this.getName(a),f=this.getSize(a);this._options.onProgress(a,d,f,f);if(200==c.status){this.log("xhr - server response received");this.log("responseText = "+c.responseText);var g;try{g=eval("("+c.responseText+")")}catch(h){g={}}this._options.onComplete(a,d,g)}else this._options.onComplete(a,d,{});this._files[a]=
null;this._xhrs[a]=null;this._dequeue(a)}},_cancel:function(a){this._options.onCancel(a,this.getName(a));this._files[a]=null;this._xhrs[a]&&(this._xhrs[a].abort(),this._xhrs[a]=null)}});window.qqUploader=a})();Craft.SlugGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(a){a=a.replace(/<(.*?)>/g,"");a=a.replace(/['"\u2018\u2019\u201c\u201d]/g,"");a=a.toLowerCase();a=Craft.filterArray(XRegExp.matchChain(a,[XRegExp("[\\p{L}\\p{N}\\.]+")]));return a.length?a.join("-"):""}});Craft.StructureDrag=
Garnish.Drag.extend({elementIndex:null,moveAction:null,maxDepth:null,draggeeDepth:null,$helperLi:null,$targets:null,_:null,draggeeHeight:null,init:function(a,b,c){this.elementIndex=a;this.moveAction=b;this.maxDepth=c;this.$insertion=d('<li class="draginsertion"/>');this._={};a=this.elementIndex.$elementContainer.find("li");this.base(a,{handle:".element:first, .move:first",helper:d.proxy(this,"getHelper")})},getHelper:function(a){this.$helperLi=a;var b=d('<ul class="structureview draghelper"/>').append(a);
a.css("padding-left",this.$draggee.css("padding-left"));a.find(".move").removeAttr("title");return b},onDragStart:function(){this.$targets=d();this.findTargets(this.elementIndex.$elementContainer);this.draggeeDepth=0;var a=this.$draggee;do this.draggeeDepth++,a=a.find("> ul > li");while(a.length);this.draggeeHeight=this.$draggee.height();this.$draggee.animate({height:0},"fast",d.proxy(function(){this.$draggee.addClass("hidden")},this));this.base();this.addListener(Garnish.$doc,"keydown",function(a){a.keyCode==
Garnish.ESC_KEY&&this.cancelDrag()})},findTargets:function(a){a=a.children().not(this.$draggee);for(var b=0;b<a.length;b++){var c=d(a[b]);this.$targets=this.$targets.add(c.children(".row"));c.hasClass("collapsed")||this.findTargets(c.children("ul"))}},onDrag:function(){this._.$closestTarget&&(this._.$closestTarget.removeClass("draghover"),this.$insertion.remove());this._.$closestTarget=null;this._.closestTargetPos=null;this._.closestTargetYDiff=null;this._.closestTargetOffset=null;this._.closestTargetHeight=
null;for(this._.i=0;this._.i<this.$targets.length;this._.i++)if(this._.$target=d(this.$targets[this._.i]),this._.targetOffset=this._.$target.offset(),this._.targetHeight=this._.$target.outerHeight(),this._.targetYMidpoint=this._.targetOffset.top+this._.targetHeight/2,this._.targetYDiff=Math.abs(this.mouseY-this._.targetYMidpoint),0==this._.i||this.mouseY>=this._.targetOffset.top+5&&this._.targetYDiff<this._.closestTargetYDiff)this._.$closestTarget=this._.$target,this._.closestTargetPos=this._.i,this._.closestTargetYDiff=
this._.targetYDiff,this._.closestTargetOffset=this._.targetOffset,this._.closestTargetHeight=this._.targetHeight;else break;if(this._.$closestTarget)if(0==this._.closestTargetPos&&this.mouseY<this._.closestTargetOffset.top+5)this.$insertion.prependTo(this.elementIndex.$elementContainer);else if(this._.$closestTargetLi=this._.$closestTarget.parent(),this._.closestTargetDepth=this._.$closestTargetLi.data("depth"),this._.closestTargetPos<this.$targets.length-1?(this._.$nextTargetLi=d(this.$targets[this._.closestTargetPos+
1]).parent(),this._.nextTargetDepth=this._.$nextTargetLi.data("depth")):(this._.$nextTargetLi=null,this._.nextTargetDepth=null),this._.hoveringBetweenRows=this.mouseY>=this._.closestTargetOffset.top+this._.closestTargetHeight-5,this._.$nextTargetLi&&this._.nextTargetDepth==this._.closestTargetDepth)this._.hoveringBetweenRows?(!this.maxDepth||this.maxDepth>=this._.closestTargetDepth+this.draggeeDepth-1)&&this.$insertion.insertAfter(this._.$closestTargetLi):(!this.maxDepth||this.maxDepth>=this._.closestTargetDepth+
this.draggeeDepth)&&this._.$closestTarget.addClass("draghover");else if(this._.$nextTargetLi&&this._.nextTargetDepth>this._.closestTargetDepth){if(!this.maxDepth||this.maxDepth>=this._.nextTargetDepth+this.draggeeDepth-1)this._.hoveringBetweenRows?this.$insertion.insertBefore(this._.$nextTargetLi):(this._.$closestTarget.addClass("draghover"),this.$insertion.appendTo(this._.$closestTargetLi.children("ul")))}else if(this._.hoveringBetweenRows){this._.draggeeX=this.mouseX-this.targetItemMouseDiffX;this._.$parentLis=
this._.$closestTarget.parentsUntil(this.elementIndex.$elementContainer,"li");this._.$closestParentLi=null;this._.closestParentLiXDiff=null;this._.closestParentDepth=null;for(this._.i=0;this._.i<this._.$parentLis.length;this._.i++)this._.$parentLi=d(this._.$parentLis[this._.i]),this._.parentLiXDiff=Math.abs(this._.$parentLi.offset().left-this._.draggeeX),this._.parentDepth=this._.$parentLi.data("depth"),(!this.maxDepth||this.maxDepth>=this._.parentDepth+this.draggeeDepth-1)&&(!this._.$closestParentLi||
this._.parentLiXDiff<this._.closestParentLiXDiff&&(!this._.$nextTargetLi||this._.parentDepth>=this._.nextTargetDepth))&&(this._.$closestParentLi=this._.$parentLi,this._.closestParentLiXDiff=this._.parentLiXDiff,this._.closestParentDepth=this._.parentDepth);this._.$closestParentLi&&this.$insertion.insertAfter(this._.$closestParentLi)}else(!this.maxDepth||this.maxDepth>=this._.closestTargetDepth+this.draggeeDepth)&&this._.$closestTarget.addClass("draghover")},cancelDrag:function(){this.$insertion.remove();
this._.$closestTarget&&this._.$closestTarget.removeClass("draghover");this.onMouseUp()},onDragStop:function(){if(this._.$closestTarget&&(this.$insertion.parent().length||this._.$closestTarget.hasClass("draghover"))){var a=this.$draggee.siblings().length?null:this.$draggee.parent();if(this.$insertion.parent().length){var b=this.$insertion.next().add(this.$insertion.prev());-1==d.inArray(this.$draggee[0],b)?(this.$insertion.replaceWith(this.$draggee),b=!0):(this.$insertion.remove(),b=!1)}else b=this._.$closestTargetLi.children("ul"),
a&&b.length&&b[0]==a[0]?b=!1:(b.length?this._.$closestTargetLi.hasClass("collapsed")&&this._.$closestTarget.children(".toggle").trigger("click"):(b=d('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(this._.$closestTarget),this.elementIndex.initToggle(b),b=d("<ul>").appendTo(this._.$closestTargetLi)),this.$draggee.appendTo(b),b=!0);this._.$closestTarget.removeClass("draghover");b&&(a&&(a.siblings(".row").children(".toggle").remove(),a.remove()),a=this.$draggee.parentsUntil(this.elementIndex.$elementContainer,
"li").length+1,a!=this.$draggee.data("depth")&&(1==this.$draggee.data("depth")?this.$helperLi.animate({"padding-left":38},"fast"):1==a&&this.$helperLi.animate({"padding-left":8},"fast"),this.setDepth(this.$draggee,a)),a={id:this.$draggee.children(".row").data("id"),prevId:this.$draggee.prev().children(".row").data("id"),parentId:this.$draggee.parent("ul").parent("li").children(".row").data("id")},Craft.postActionRequest(this.moveAction,a,function(a,b){"success"==b&&Craft.cp.displayNotice(Craft.t("New order saved."))}))}this.$draggee.stop().removeClass("hidden").animate({height:this.draggeeHeight},
"fast",d.proxy(function(){this.$draggee.css("height","auto")},this));this.returnHelpersToDraggees();this.base()},setDepth:function(a,b){a.data("depth",b);var c=8+35*(b-1);this.$draggee.children(".row").css({"margin-left":"-"+c+"px","padding-left":c+"px"});for(var c=a.children("ul").children(),e=0;e<c.length;e++)this.setDepth(d(c[e]),b+1)}});Craft.TagSelectInput=Craft.BaseElementSelectInput.extend({id:null,name:null,tagSetId:null,elementId:null,elementSort:null,searchTimeout:null,menu:null,$container:null,
$elementsContainer:null,$elements:null,$addTagInput:null,$spinner:null,init:function(a,b,c,e,f){this.id=a;this.name=b;this.tagSetId=c;this.elementId=e;this.$container=d("#"+this.id);this.$elementsContainer=this.$container.children(".elements");this.$elements=this.$elementsContainer.children();this.$addTagInput=this.$container.children(".add").children(".text");this.$spinner=this.$addTagInput.next();this.totalElements=this.$elements.length;this.elementSelect=new Garnish.Select(this.$elements,{multi:!0,
filter:":not(.delete)"});this.elementSort=new Garnish.DragSort({container:this.$elementsContainer,filter:d.proxy(function(){return this.elementSelect.getSelectedItems()},this),caboose:d('<div class="caboose"/>'),onSortChange:d.proxy(function(){this.elementSelect.resetItemOrder()},this)});this.initElements(this.$elements);this.addListener(this.$addTagInput,"textchange",d.proxy(function(){this.searchTimeout&&clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(d.proxy(this,"searchForTags"),
500)},this));this.addListener(this.$addTagInput,"keypress",function(a){a.keyCode==Garnish.RETURN_KEY&&(a.preventDefault(),this.searchMenu&&this.selectTag(this.searchMenu.$options[0]))});this.addListener(this.$addTagInput,"focus",function(){this.searchMenu&&this.searchMenu.show()});this.addListener(this.$addTagInput,"blur",function(){setTimeout(d.proxy(function(){this.searchMenu&&this.searchMenu.hide()},this),1)});f&&this._attachHUDEvents()},searchForTags:function(){this.searchMenu&&this.killSearchMenu();
if(this.$addTagInput.val()){this.$spinner.removeClass("hidden");for(var a=[],b=0;b<this.$elements.length;b++){var c=d(this.$elements[b]).data("id");c&&a.push(c)}this.elementId&&a.push(this.elementId);var e={search:this.$addTagInput.val(),tagSetId:this.tagSetId,excludeIds:a};Craft.postActionRequest("tags/searchForTags",e,d.proxy(function(a,b){this.$spinner.addClass("hidden");if("success"==b){var c=d('<div class="menu tagmenu"/>').appendTo(Garnish.$bod),k=d("<ul/>").appendTo(c);if(!a.exactMatch){var m=
d("<li/>").appendTo(k);d('<a class="hover"/>').appendTo(m).text(e.search)}for(var l=0;l<a.tags.length;l++)m=d("<li/>").appendTo(k),m=d("<a/>").appendTo(m).text(a.tags[l].name).data("id",a.tags[l].id),a.exactMatch&&0==l&&m.addClass("hover");this.searchMenu=new Garnish.Menu(c,{attachToElement:this.$addTagInput,onOptionSelect:d.proxy(this,"selectTag")});this.searchMenu.show()}},this))}else this.$spinner.addClass("hidden")},selectTag:function(a){var b=d(a);a=d('<div class="element removable"/>').appendTo(this.$elementsContainer);
var c=d('<input type="hidden" name="'+this.name+'[]"/>').appendTo(a);b.data("id")?(a.data("id",b.data("id")),c.val(b.data("id"))):c.val("new:"+b.text());d('<a class="delete icon" title="'+Craft.t("Remove")+'"></a>').appendTo(a);d('<span class="label">'+b.text()+"</span>").appendTo(a);b=-(a.outerWidth()+10);this.$addTagInput.css("margin-left",b+"px");this.$addTagInput.animate({marginLeft:0},"fast");this.$elements=this.$elements.add(a);this.totalElements++;this.initElements(a);this.killSearchMenu();
this.$addTagInput.val("");this.$addTagInput.focus()},killSearchMenu:function(){this.searchMenu.hide();this.searchMenu.destroy();this.searchMenu=null},_attachHUDEvents:function(){this.removeListener(this.$elements,"dlbclick");this.addListener(this.$elements,"dblclick",d.proxy(this,"_editProperties"))},_editProperties:function(a){a=d(a.currentTarget);if(!a.data("ElementEditor")){var b={elementId:a.attr("data-id"),$trigger:a,loadContentAction:"tags/editTagContent",saveContentAction:"tags/saveTagContent"};
a.data("ElementEditor",new Craft.ElementEditor(b))}a.data("ElementEditor").show()}});Craft.Uploader=Garnish.Base.extend({uploader:null,init:function(a,b){b=d.extend(this.defaultSettings,b);b.element=a[0];this.uploader=new qqUploader.FileUploader(b)},setParams:function(a){this.uploader.setParams(a)},getInProgress:function(){return this.uploader.getInProgress()},defaultSettings:{action:Craft.actionUrl+"/assets/uploadFile",template:'<div class="assets-qq-uploader"><div class="assets-qq-upload-drop-area"></div><a href="javascript:;" class="btn submit assets-qq-upload-button" data-icon="\u2191" style="position: relative; overflow: hidden; direction: ltr; " role="button">'+
Craft.t("Upload files")+'</a><ul class="assets-qq-upload-list hidden"></ul></div>',fileTemplate:'<li><span class="assets-qq-upload-file"></span><span class="assets-qq-upload-spinner"></span><span class="assets-qq-upload-size"></span><a class="assets-qq-upload-cancel" href="#">Cancel</a><span class="assets-qq-upload-failed-text">Failed</span></li>',classes:{button:"assets-qq-upload-button",drop:"assets-qq-upload-drop-area",dropActive:"assets-qq-upload-drop-area-active",list:"assets-qq-upload-list",
file:"assets-qq-upload-file",spinner:"assets-qq-upload-spinner",size:"assets-qq-upload-size",cancel:"assets-qq-upload-cancel",success:"assets-qq-upload-success",fail:"assets-qq-upload-fail"},onSubmit:d.noop,onProgress:d.noop,onComplete:d.noop}})})(jQuery);

//# sourceMappingURL=craft.min.map
